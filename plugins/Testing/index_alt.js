var ee=(r,e)=>{let t=null;function i(){t?.remove(),t=null}function a(s){e&&(t=document.getElementById(e)),!s||!s.trim()?i():(t||(t=document.createElement("style"),e&&(t.id=e),document.head.appendChild(t)),t.innerHTML=s)}return a(r),{set css(s){a(s)},get css(){return t?.innerHTML??""},remove:i}};var te='.context-button{align-items:center;display:flex;font-weight:500;padding:20px 16px;width:100%;height:45px;flex-grow:1;color:#b878ff;position:relative}.context-button:hover{background-color:#9e46ff;color:#fff}.context-button::before{content:"";position:absolute;top:0;left:0;height:100%;width:var(--progress,0);background:rgba(255,255,255,.25);z-index:1}.context-button.loading{background-color:#9e46ff;cursor:not-allowed;color:#fff}.context-button span{z-index:2;position:relative}';ee(te,"content-button");import{actions as $e}from"@neptune";import{intercept as re}from"@neptune";var f=(r,e,t,{timeoutMs:i,cancel:a}={})=>{i??=5e3,a??=!1;let s,n,o=new Promise((d,b)=>{s=d,n=b}),u=re(e,d=>{if(s(d),a)return!0},!0),l=re(t,n,!0),m=setTimeout(()=>n(`${t??e}_TIMEOUT`),i);return r(),o.finally(()=>{clearTimeout(m),u(),l()})};var Ue=(r,e)=>r.toLowerCase().includes(e.toLowerCase()),ie=(r,e)=>{let t=e?.title.replaceAll("\u2019","'"),i=r?.title,a=t??i;if(a===void 0)return;if(i?.includes("feat. ")&&!t?.includes("feat. ")){let n=e?.["artist-credit"];n&&n.findIndex(u=>u.joinphrase===" feat. ")!==-1&&(a=i)}let s=r?.version;return s&&!Ue(a,s)&&(a+=` (${s})`),a},D=r=>r?.flatMap(e=>e===void 0?[]:typeof e=="string"?e:e?.name).filter(e=>e!==void 0)??[],Fe=(r,e)=>{let t=r.artists?.find(i=>i?.id===e?.artist?.id);if(t?.name!==void 0)return D([t.name]);if((r.artists?.length??-1)>0)return D(r.artists);if(r.artist?.name!==void 0)return D([r.artist.name])},_=["title","trackNumber","discNumber","date","copyright","REPLAYGAIN_TRACK_GAIN","REPLAYGAIN_TRACK_PEAK","comment","isrc","upc","musicbrainz_trackid","musicbrainz_albumid","artist","album","albumArtist","genres","organization","totalTracks","lyrics"],qe=(r,e="/1280x1280.jpg")=>r?"https://resources.tidal.com/images/"+r.split("-").join("/")+e:void 0,ae=async r=>{let e=f(()=>$e.content.loadItemLyrics({itemId:r.tidalTrack.id,itemType:"track"}),["content/LOAD_ITEM_LYRICS_SUCCESS"],["content/LOAD_ITEM_LYRICS_FAIL"]).catch(()=>{}).then(b=>b?.[0]),[t,i,a]=await Promise.all([r.tidalAlbum(),r.releaseTrack(),r.releaseAlbum()]),s=r.tidalTrack,n={};s.title!==void 0&&(n.title=ie(s,i)),s.trackNumber!==void 0&&(n.trackNumber=s.trackNumber.toString()),s.releaseDate!==void 0&&(n.date=s.releaseDate),s.peak&&(n.REPLAYGAIN_TRACK_PEAK=s.peak.toString()),s.url&&(n.comment=s.url),s.contentType==="track"&&(s.copyright&&(n.copyright=s.copyright),s.replayGain&&(n.REPLAYGAIN_TRACK_GAIN=s.replayGain.toString())),s.volumeNumber!==void 0&&(n.discNumber=s.volumeNumber.toString());let o=s.isrc??i?.recording.isrcs?.[0];o&&(n.isrc=o);let u=t?.upc??a?.barcode;u&&(n.upc=u),i?.recording?.id&&(n.musicbrainz_trackid=i.recording.id.toString()),a?.id&&(n.musicbrainz_albumid=a.id.toString());let l=Fe(s,t);l&&(n.artist=l),n.album=ie(s.album,a);let m=s.album?.cover;t!==void 0&&((t.artists?.length??-1)>0?n.albumArtist=D(t.artists):t.artist?.name&&(n.albumArtist=[t.artist.name]),t.genre&&(n.genres=t.genre),t.recordLabel&&(n.organization=t.recordLabel),t.numberOfTracks&&(n.totalTracks=t.numberOfTracks.toString()),!n.date&&t.releaseDate&&(n.date=t.releaseDate),!n.date&&t.releaseYear&&(n.date=t.releaseYear.toString()),m??=t.cover);let d=(await e)?.lyrics;return d!==void 0&&(n.lyrics=d),n.album??="Unknown Album",n.artist??=["Unknown Artist"],{tags:n,coverUrl:qe(m)}};import{html as Ve}from"@neptune/voby";import{storage as U}from"@plugin";var ne=r=>{U.settings??={};for(let e of Object.keys(r))U.settings[e]??=r[e];return U.settings};var P=(s=>(s.HiRes="HI_RES_LOSSLESS",s.MQA="HI_RES",s.High="LOSSLESS",s.Low="HIGH",s.Lowest="LOW",s))(P||{});var F=Object.values(P),se=["HI_RES_LOSSLESS","LOSSLESS","HIGH","LOW"],Ft=Object.fromEntries(Object.entries(P).map(([r,e])=>[e,r]));import{html as oe}from"@neptune/voby";import{html as Xe}from"@neptune/voby";var A=({children:r,tooltip:e})=>Xe`
	<div style="margin-bottom: 15px;display: flex;justify-content: space-between;align-items: center;" title="${e}">${r}</div>
`;var ue=({selected:r,onSelect:e,options:t,title:i,tooltip:a})=>oe`
		<${A} tooltip=${a}>
			<label for="dropdown-${i}" style="font-size: 1.2em;margin-right: 10px;">${i}</label>
			<select id="dropdown-${i}" value=${r} onChange=${n=>e?.(n.target.value)} style="flex-grow: 1; max-width: 180px; background: var(--wave-color-solid-base-brighter);border-bottom: 1px solid var(--wave-color-opacity-contrast-fill-ultra-thin); color: var(--wave-color-opacity-contrast-fill-t);">
				${t.map(n=>oe`<option class="neptune-card" value=${n} selected=${n===r}>${n}</option>`)}
			</select>
		<//>
	`;import{html as Ge}from"@neptune/voby";var q=({text:r,onText:e,title:t,tooltip:i})=>Ge`
		<${A} tooltip=${i}>
			<label for="text-${t}" style="font-size: 1.2em;margin-right: 16px;">${t}</label>
			<input id="text-${t}" value=${r} onChange=${s=>e?.(s.target.value)} style="flex-grow: 1; background: var(--wave-color-solid-base-brighter);border-bottom: 1px solid var(--wave-color-opacity-contrast-fill-ultra-thin);border-right: 1px solid var(--wave-color-opacity-contrast-fill-ultra-thin); color: var(--wave-color-opacity-contrast-fill-t);" />
		<//>
	`;import{html as He}from"@neptune/voby";var le=({checked:r,onClick:e,title:t,tooltip:i})=>(r??=!1,He`
		<${A} tooltip=${i}>
			<label for="switch-${t}" style="font-size: 1.2em;margin-bottom: 5px;">${t}</label>
			<input id="switch-${t}" class="neptune-switch-checkbox" type="checkbox" checked=${r} />
			<span onClick=${e} class="neptune-switch" />
		<//>
	`);var N="{artist} - {album} - {title}",c=ne({desiredDownloadQuality:"HI_RES_LOSSLESS",defaultDownloadPath:"",alwaysUseDefaultPath:!1,filenameFormat:N,useRealMAX:!1});c.filenameFormat===""&&(c.filenameFormat=N);c.filenameFormat==="artist - album - title"&&(c.filenameFormat=N);var je=()=>Ve`<div style="display: grid; grid-gap: 20px; margin-top: 20px;">
	<${ue}
		selected=${c.desiredDownloadQuality}
		onSelect=${r=>c.desiredDownloadQuality=r}
		options=${se}
		title="Download quality"
	/>
	<${q}
		text=${c.defaultDownloadPath}
		onText=${r=>{c.defaultDownloadPath=r,r===""&&(c.alwaysUseDefaultPath=!1)}}
		title="Default save path"
	/>
	<${le}
		checked=${c.defaultDownloadPath!==""&&c.alwaysUseDefaultPath}
		onClick=${()=>c.alwaysUseDefaultPath=!c.alwaysUseDefaultPath}
		title="Skip save prompt (requires default path)"
	/>
	<${q}
		text=${c.filenameFormat}
		onText=${r=>{r===""?c.filenameFormat=N:c.filenameFormat=r}}
		title="Filename format"
		tooltip="Availble tags: ${_.join(", ")}"
	/>
</div>`;var We=/[\/:*?"<>|]/g,Qe=r=>r.replace(We,"");var Ye=({tags:r},{manifest:e,manifestMimeType:t})=>{let i=c.filenameFormat;for(let a of _){let s=r[a];if(Array.isArray(s)&&(s=s[0]),s!==void 0){if(a==="date"&&typeof s=="string")try{let n=new Date(s);isNaN(n.getTime())||(s=n.getFullYear().toString())}catch(n){console.warn(`Failed to parse date tag: ${s}`,n)}i=i.replaceAll(`{${a}}`,Qe(s))}}switch(t){case"application/vnd.tidal.bts":return e.codecs==="mqa"?`${i}.mqa.flac`:`${i}.${e.codecs}`;case"application/dash+xml":{let a=e.tracks.audios[0];return`${i}.${a.codec.toLowerCase()}.m4a`}}},T=navigator.userAgent.includes("Win")?"\\":"/",ce=(r,e)=>{let t=Ye(r,e);t=T==="\\"?t.replaceAll("/",T):t;let i=t.split(T);return{fileName:i.pop(),folderPath:i.join(T)}};import{actions as X}from"@neptune";var G=r=>{let e=o=>{let u=(...l)=>{o(r,...l)};return u.withContext=l=>(...m)=>{o(r,l,...m)},u},t=e(console.log),i=e(console.warn),a=e(console.error),s=e(console.debug),n=(o,u,l)=>{let m=d=>{o(d),u({message:`${r} - ${d}`,category:"OTHER",severity:l})};return m.withContext=d=>{let b=o.withContext(d);return y=>{b(y),y instanceof Error&&(y=y.message),u({message:`${r}.${d} - ${y}`,category:"OTHER",severity:l})}},m};return{log:t,warn:i,err:a,debug:s,msg:{log:n(t,X.message.messageInfo,"INFO"),warn:n(i,X.message.messageWarn,"WARN"),err:n(a,X.message.messageError,"ERROR")}}},p=G("[lib]");import{intercept as J}from"@neptune";import{store as de}from"@neptune";import{store as ze}from"@neptune";var O=()=>ze.getState()?.playbackControls??{};var g=class{static _cache={};static current(e){if(e??=O()?.playbackContext,e?.actualProductId!==void 0)return this.ensure(e.actualProductId)}static async ensureTrack(e){let t=await this.ensure(e);if(t?.contentType==="track")return t}static async ensureVideo(e){let t=await this.ensure(e);if(t?.contentType==="video")return t}static async ensure(e){if(e===void 0)return;let t=this._cache[e];if(t!==void 0)return t;let i=de.getState().content.mediaItems;for(let a in i){let s=i[a]?.item;this._cache[a]=s}if(this._cache[e]===void 0){let a=window.location.pathname;await f(()=>neptune.actions.router.replace(`/track/${e}`),["page/IS_DONE_LOADING"],[]).then(()=>!0).catch(p.warn.withContext(`TrackItemCache.ensure failed to load track ${e}`))||await f(()=>neptune.actions.router.replace(`/video/${e}`),["page/IS_DONE_LOADING"],[]).catch(p.warn.withContext(`TrackItemCache.ensure failed to load video ${e}`)),neptune.actions.router.replace(a);let o=de.getState().content.mediaItems[+e]?.item;this._cache[e]=o}return this._cache[e]}};import{actions as Ee,store as lt}from"@neptune";var j=(r,e)=>e.some(t=>r instanceof t),pe,me;function Je(){return pe||(pe=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ze(){return me||(me=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var K=new WeakMap,H=new WeakMap,L=new WeakMap;function et(r){let e=new Promise((t,i)=>{let a=()=>{r.removeEventListener("success",s),r.removeEventListener("error",n)},s=()=>{t(w(r.result)),a()},n=()=>{i(r.error),a()};r.addEventListener("success",s),r.addEventListener("error",n)});return L.set(e,r),e}function tt(r){if(K.has(r))return;let e=new Promise((t,i)=>{let a=()=>{r.removeEventListener("complete",s),r.removeEventListener("error",n),r.removeEventListener("abort",n)},s=()=>{t(),a()},n=()=>{i(r.error||new DOMException("AbortError","AbortError")),a()};r.addEventListener("complete",s),r.addEventListener("error",n),r.addEventListener("abort",n)});K.set(r,e)}var W={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return K.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return w(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function be(r){W=r(W)}function rt(r){return Ze().includes(r)?function(...e){return r.apply(Q(this),e),w(this.request)}:function(...e){return w(r.apply(Q(this),e))}}function it(r){return typeof r=="function"?rt(r):(r instanceof IDBTransaction&&tt(r),j(r,Je())?new Proxy(r,W):r)}function w(r){if(r instanceof IDBRequest)return et(r);if(H.has(r))return H.get(r);let e=it(r);return e!==r&&(H.set(r,e),L.set(e,r)),e}var Q=r=>L.get(r);function z(r,e,{blocked:t,upgrade:i,blocking:a,terminated:s}={}){let n=indexedDB.open(r,e),o=w(n);return i&&n.addEventListener("upgradeneeded",u=>{i(w(n.result),u.oldVersion,u.newVersion,w(n.transaction),u)}),t&&n.addEventListener("blocked",u=>t(u.oldVersion,u.newVersion,u)),o.then(u=>{s&&u.addEventListener("close",()=>s()),a&&u.addEventListener("versionchange",l=>a(l.oldVersion,l.newVersion,l))}).catch(()=>{}),o}var at=["get","getKey","getAll","getAllKeys","count"],nt=["put","add","delete","clear"],V=new Map;function fe(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(V.get(e))return V.get(e);let t=e.replace(/FromIndex$/,""),i=e!==t,a=nt.includes(t);if(!(t in(i?IDBIndex:IDBObjectStore).prototype)||!(a||at.includes(t)))return;let s=async function(n,...o){let u=this.transaction(n,a?"readwrite":"readonly"),l=u.store;return i&&(l=l.index(o.shift())),(await Promise.all([l[t](...o),a&&u.done]))[0]};return V.set(e,s),s}be(r=>({...r,get:(e,t,i)=>fe(e,t)||r.get(e,t,i),has:(e,t)=>!!fe(e,t)||r.has(e,t)}));var st=["continue","continuePrimaryKey","advance"],he={},Y=new WeakMap,ye=new WeakMap,ot={get(r,e){if(!st.includes(e))return r[e];let t=he[e];return t||(t=he[e]=function(...i){Y.set(this,ye.get(this)[e](...i))}),t}};async function*ut(...r){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...r)),!e)return;e=e;let t=new Proxy(e,ot);for(ye.set(t,e),L.set(t,Q(e));e;)yield t,e=await(Y.get(t)||e.continue()),Y.delete(t)}function ge(r,e){return e===Symbol.asyncIterator&&j(r,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&j(r,[IDBIndex,IDBObjectStore])}be(r=>({...r,get(e,t,i){return ge(e,t)?ut:r.get(e,t,i)},has(e,t){return ge(e,t)||r.has(e,t)}}));var E=class{constructor(e){this.avalibleSlots=e}queued=[];async obtain(){let e=!1,t=()=>{e||(e=!0,this.avalibleSlots++,this.queued.shift()?.())};return this.avalibleSlots>0?(this.avalibleSlots--,t):new Promise(i=>{this.queued.push(()=>{this.avalibleSlots--,i(t)})})}};var Te="@inrixia/sharedStorage",h=class r{constructor(e,t){this.storeName=e;r.openDB(e,t)}static db;static openSema=new E(1);static async openDB(e,t){let i=await this.openSema.obtain();try{let a=n=>async()=>{await n.close(),this.openDB(e,t)};this.db=z(Te).then(async n=>(n.addEventListener("versionchange",a(n)),n.objectStoreNames.contains(e)?n:(await n.close(),z(Te,n.version+1,{blocking:a(n),upgrade(o){o.createObjectStore(e,t)}}))));let s=await this.db;s.addEventListener("versionchange",a(s))}finally{i()}}static close(){return this.db?.then(e=>e.close())}add(e,t){return r.db.then(i=>i.add(this.storeName,e,t))}clear(){return r.db.then(e=>e.clear(this.storeName))}count(e){return r.db.then(t=>t.count(this.storeName,e))}delete(e){return r.db.then(t=>t.delete(this.storeName,e))}get(e){return r.db.then(t=>t.get(this.storeName,e))}getAll(e,t){return r.db.then(i=>i.getAll(this.storeName,e,t))}getAllKeys(e,t){return r.db.then(i=>i.getAllKeys(this.storeName,e,t))}getKey(e){return r.db.then(t=>t.getKey(this.storeName,e))}put(e,t){return r.db.then(i=>i.put(this.storeName,e,t))}};var _r=1e3*60*60*24,S=class{static _cache={};static _trackItemsCache=new h("AlbumCache.trackItems",{keyPath:"albumId"});static async get(e){if(e===void 0)return;let t=this._cache[e];if(t!==void 0)return t;let i=lt.getState().content.albums;for(let a in i)this._cache[a]=i[a];if(this._cache[e]===void 0){let a=await f(()=>Ee.content.loadAlbum({albumId:e}),["content/LOAD_ALBUM_SUCCESS"],[]).then(s=>s?.[0].album).catch(p.warn.withContext("AlbumCache.get"));a!==void 0&&(this._cache[e]=a)}return this._cache[e]}static async getTrackItems(e){if(e===void 0)return;let t=await this._trackItemsCache.get(e),i=this.updateTrackItems(e);return t?.trackItems!==void 0?t.trackItems:i}static async updateTrackItems(e){let t=await f(()=>Ee.content.loadAllAlbumMediaItems({albumId:e}),["content/LOAD_ALL_ALBUM_MEDIA_ITEMS_SUCCESS"],["content/LOAD_ALL_ALBUM_MEDIA_ITEMS_FAIL"],{timeoutMs:2e3}).catch(p.warn.withContext("PlaylistCache.getTrackItems.interceptPromise"));if(t?.[0]?.mediaItems===void 0)return(await this._trackItemsCache.get(e))?.trackItems;let i=Array.from((t?.[0]?.mediaItems).map(a=>a?.item).filter(a=>a?.contentType==="track"));return await this._trackItemsCache.put({albumId:e,trackItems:i}),i}};import{actions as ct}from"@neptune";var x=class extends h{maxAge;constructor(e,t){let{maxAge:i,storeSchema:a}=t??{};super(e,a),this.maxAge=i}setExpires(e,t){if(t!==void 0)e.__expires=t;else if(this.maxAge!==void 0)e.__expires=Date.now()+this.maxAge;else throw new Error("maxAge or expires must be set!")}clearExpires(e){delete e.__expires}isTooOld(e){return e?.__expires===void 0?!0:Date.now()>e.__expires}async add(e,t){return this.setExpires(e),super.add(e,t)}async put(e,t){return this.setExpires(e),super.put(e,t)}async addExpires(e,t,i){return this.setExpires(e,t),super.add(e,i)}async putExpires(e,t,i){return this.setExpires(e,t),super.put(e,i)}async get(e){let t=await super.get(e);if(!this.isTooOld(t))return this.clearExpires(t),t}async getWithExpiry(e){let t=await super.get(e);if(t===void 0)return{value:void 0,expires:void 0,expired:void 0};let i=t.__expires,a=this.isTooOld(t);return this.clearExpires(t),{value:t,expires:i,expired:a}}async getAll(e,t){return(await super.getAll(e,t)).filter(this.isTooOld.bind(this)).map(this.clearExpires.bind(this))}};var M=class{static _trackItemsCache=new x("PlaylistCache.trackItems",{maxAge:3e4,storeSchema:{keyPath:"playlistUUID"}});static async getTrackItems(e){if(e===void 0)return;let t=await this._trackItemsCache.get(e),i=this.updateTrackItems(e);return t?.trackItems!==void 0?t.trackItems:i}static async updateTrackItems(e){let t=await f(()=>ct.content.loadListItemsPage({loadAll:!0,listName:`playlists/${e}`,listType:"mediaItems"}),["content/LOAD_LIST_ITEMS_PAGE_SUCCESS","content/LOAD_LIST_ITEMS_PAGE_SUCCESS_MODIFIED"],["content/LOAD_LIST_ITEMS_PAGE_FAIL"],{timeoutMs:3e3}).catch(p.warn.withContext("PlaylistCache.getTrackItems.interceptPromise"));if(t?.[0]?.items===void 0)return(await this._trackItemsCache.get(e))?.trackItems;let i=Array.from((t?.[0]?.items).map(a=>a?.item).filter(a=>a?.contentType==="track"));return await this._trackItemsCache.put({playlistUUID:e,trackItems:i}),i}};var R=class r{static _intercepts=[J(["contextMenu/OPEN_MEDIA_ITEM"],([e])=>{(async()=>this._onOpen({type:"TRACK"},await this.getTrackItems([e.id])))()}),J(["contextMenu/OPEN_MULTI_MEDIA_ITEM"],([e])=>{(async()=>this._onOpen({type:"TRACK"},await this.getTrackItems(e.ids)))()}),J("contextMenu/OPEN",([e])=>{switch(e.type){case"ALBUM":{S.getTrackItems(e.id).then(t=>{t!==void 0&&this._onOpen({type:"ALBUM",albumId:e.id},t)});break}case"PLAYLIST":{M.getTrackItems(e.id).then(t=>{t!==void 0&&this._onOpen({type:"PLAYLIST",playlistId:e.id},t)});break}}})];static async getTrackItems(e){return(await Promise.all(e.map(g.ensureTrack.bind(g)))).filter(i=>i!==void 0)}static _onOpen(e,t){setTimeout(async()=>{let i=0,a=document.querySelector('[data-type="list-container__context-menu"]');for(;a===null&&i<50;)await new Promise(s=>setTimeout(s,50)),a=document.querySelector('[data-type="list-container__context-menu"]');if(a!==null)for(let s of this._listeners)s(e,a,t).catch(p.err.withContext("ContextMenu.listener"))})}static _listeners=[];static onOpen(e){r._listeners.push(e)}static onUnload(){this._intercepts.forEach(e=>e())}};var we=async()=>{await h.close(),await R.onUnload()};import{modules as dt}from"@neptune";var ve=(r,e)=>{for(let t of dt)if(typeof t?.exports=="object")for(let i in t.exports){let a=t.exports[i]?.[r];if(typeof a===e)return a}};var pt=NeptuneNative.createEvalScope(`
						electron.ipcMain.removeHandler("___lib/native/dasha.native.ts_registerExports");
						electron.ipcMain.handle("___lib/native/dasha.native.ts_registerExports", (_, code, globalName) => {
							const exports = eval(\`(() => {\${code};return \${globalName};})()\`)
							electron.ipcMain.removeHandler("___lib/native/dasha.native.ts");
							electron.ipcMain.handle("___lib/native/dasha.native.ts", (_, exportName, ...args) => exports[exportName](...args));
						});
					`);NeptuneNative.deleteEvalScope(pt);await window.electron.ipcRenderer.invoke("___lib/native/dasha.native.ts_registerExports",'"use strict";var neptuneExports=(()=>{var ee=Object.create;var Q=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var re=Object.getPrototypeOf,ae=Object.prototype.hasOwnProperty;var ne=(i=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(i,{get:(s,t)=>(typeof require<"u"?require:s)[t]}):i)(function(i){if(typeof require<"u")return require.apply(this,arguments);throw Error(\'Dynamic require of "\'+i+\'" is not supported\')});var O=(i,s)=>()=>(s||i((s={exports:{}}).exports,s),s.exports),oe=(i,s)=>{for(var t in s)Q(i,t,{get:s[t],enumerable:!0})},mt=(i,s,t,e)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of se(s))!ae.call(i,r)&&r!==t&&Q(i,r,{get:()=>s[r],enumerable:!(e=ie(s,r))||e.enumerable});return i};var ue=(i,s,t)=>(t=i!=null?ee(re(i)):{},mt(s||!i||!i.__esModule?Q(t,"default",{value:i,enumerable:!0}):t,i)),ce=i=>mt(Q({},"__esModule",{value:!0}),i);var Tt=O((Ns,bt)=>{function le(i,s={}){var t=s.pos||0,e=!!s.keepComments,r=!!s.keepWhitespace,n="<",o=60,u=">",l=62,g=45,m=47,p=33,d=39,h=34,T=91,a=93;function D(A){for(var S=[];i[t];)if(i.charCodeAt(t)==o){if(i.charCodeAt(t+1)===m){var P=t+2;t=i.indexOf(u,t);var U=i.substring(P,t);if(U.indexOf(A)==-1){let N=i.substring(0,t).split(`\n`);throw new Error(`Unexpected close tag\nLine: `+(N.length-1)+`\nColumn: `+(N[N.length-1].length+1)+`\nChar: `+i[t])}return t+1&&(t+=1),S}else if(i.charCodeAt(t+1)===p){if(i.charCodeAt(t+2)==g){let N=t;for(;t!==-1&&!(i.charCodeAt(t)===l&&i.charCodeAt(t-1)==g&&i.charCodeAt(t-2)==g&&t!=-1);)t=i.indexOf(u,t+1);t===-1&&(t=i.length),e&&S.push(i.substring(N,t+1))}else if(i.charCodeAt(t+2)===T&&i.charCodeAt(t+8)===T&&i.substr(t+3,5).toLowerCase()==="cdata"){var $=i.indexOf("]]>",t);$==-1?(S.push(i.substr(t+9)),t=i.length):(S.push(i.substring(t+9,$)),t=$+3);continue}else{let N=t+1;t+=2;for(var R=!1;(i.charCodeAt(t)!==l||R===!0)&&i[t];)i.charCodeAt(t)===T?R=!0:R===!0&&i.charCodeAt(t)===a&&(R=!1),t++;S.push(i.substring(N,t))}t++;continue}var y=I();S.push(y),y.tagName[0]==="?"&&(S.push(...y.children),y.children=[])}else{let N=C();if(r)N.length>0&&S.push(N);else{var F=N.trim();F.length>0&&S.push(F)}t++}return S}function C(){var A=t;return t=i.indexOf(n,t)-1,t===-2&&(t=i.length),i.slice(A,t+1)}var f=`\\r\n	>/= `;function c(){for(var A=t;f.indexOf(i[t])===-1&&i[t];)t++;return i.slice(A,t)}var E=s.noChildNodes||["img","br","input","meta","link","hr"];function I(){t++;let A=c(),S={},P=[];for(;i.charCodeAt(t)!==l&&i[t];){var U=i.charCodeAt(t);if(U>64&&U<91||U>96&&U<123){for(var $=c(),R=i.charCodeAt(t);R&&R!==d&&R!==h&&!(R>64&&R<91||R>96&&R<123)&&R!==l;)t++,R=i.charCodeAt(t);if(R===d||R===h){var y=b();if(t===-1)return{tagName:A,attributes:S,children:P}}else y=null,t--;S[$]=y}t++}if(i.charCodeAt(t-1)!==m)if(A=="script"){let F=t+1;t=i.indexOf("<\/script>",t),P=[i.slice(F,t)],t+=9}else if(A=="style"){let F=t+1;t=i.indexOf("</style>",t),P=[i.slice(F,t)],t+=8}else E.indexOf(A)===-1?(t++,P=D(A)):t++;else t++;return{tagName:A,attributes:S,children:P}}function b(){var A=i[t],S=t+1;return t=i.indexOf(A,S),i.slice(S,t)}function B(){var A=new RegExp("\\\\s"+s.attrName+`\\\\s*=[\'"]`+s.attrValue+`[\'"]`).exec(i);return A?A.index:-1}let M=null;if(s.attrValue!==void 0)for(s.attrName=s.attrName||"id",M=[];(t=B())!==-1;)t=i.lastIndexOf("<",t),t!==-1&&M.push(I()),i=i.substr(t),t=0;else s.parseNode?M=I():M=D("");return s.filter&&(M=it(M,s.filter)),s.setPos&&(M.pos=t),M}function it(i,s,t=0,e=""){var r=[];return i.forEach(function(n,o){if(typeof n=="object"&&s(n,o,t,e)&&r.push(n),n.children){var u=it(n.children,s,t+1,(e?e+".":"")+o+"."+n.tagName);r=r.concat(u)}}),r}bt.exports={parse:le,filter:it}});var x=O((Os,Rt)=>{"use strict";var Et=(i,s=["Bytes","KB","MB","GB","TB"])=>{if(i==0)return`0 ${s[0]}`;let t=parseInt(Math.floor(Math.log(i)/Math.log(1024)));return t==0?i+" "+s[t]:(i/Math.pow(1024,t)).toFixed(1)+" "+s[t]},fe=(i,s)=>({b:i*s,kb:i/1e3*s,mb:i/8e6*s,gb:i/8e9*s,toString(){return Et(i*s)}}),ge=i=>({bps:i,kbps:i/1e3,mbps:i/8e6,gbps:i/8e9,toString(){return Et(i,["bps","Kbps","Mbps","Gbps"])}}),At=[{width:7680,height:4320},{width:3840,height:2160},{width:2560,height:1440},{width:1920,height:1080},{width:1280,height:720},{width:1024,height:576},{width:854,height:480},{width:640,height:360},{width:426,height:240},{width:256,height:144}],de=i=>At.find(s=>s.height===i)?.width,St=i=>At.find(s=>s.width===i)?.height,pe=i=>`${St(i.width)||i.height}p`,he=i=>{let s=Math.max(...i.map(t=>t.bitrate.bps));return i.find(t=>t.bitrate.bps===s)},me=i=>{let u=/P(?:(\\d*)Y)?(?:(\\d*)M)?(?:(\\d*)D)?(?:T(?:(\\d*)H)?(?:(\\d*)M)?(?:([\\d.]*)S)?)?/.exec(i);if(!u)return 0;let[l,g,m,p,d,h]=u.slice(1);return parseFloat(l||0)*31536e3+parseFloat(g||0)*2592e3+parseFloat(m||0)*86400+parseFloat(p||0)*3600+parseFloat(d||0)*60+parseFloat(h||0)},be=i=>{try{return Intl.getCanonicalLocales(i),!0}catch{return!1}};Rt.exports={parseSize:fe,parseBitrate:ge,getWidth:de,getHeight:St,getQualityLabel:pe,getBestTrack:he,parseDuration:me,isLanguageTagValid:be}});var rt=O((vs,Ct)=>{var{parseBitrate:Te,getQualityLabel:Ee,parseSize:Ae}=x(),G={avc:"H.264",hevc:"H.265",vc1:"VC-1",vp8:"VP8",vp9:"VP9",av1:"AV1"},H={sdr:"SDR",hlg:"HLG",hdr10:"HDR10",hdr10p:"HDR10+",dv:"DV"},st={Unspecified:0,BT_709:1,BT_601_625:5,BT_601_525:6,BT_2020_and_2100:9,SMPTE_ST_2113_and_EG_4321:12},j={Unspecified:0,BT_709:1,BT_601:6,BT_2020:14,BT_2100:15,BT_2100_PQ:16,BT_2100_HLG:18},Se={RGB:0,YCbCr_BT_709:1,YCbCr_BT_601_625:5,YCbCr_BT_601_525:6,YCbCr_BT_2020_and_2100:9,ICtCp_BT_2100:14},Re=i=>{let s=i.toLowerCase().trim().split(".")[0],t=["avc1","avc2","avc3","dva1","dvav"],e=["hev1","hev2","hev3","hvc1","hvc2","hvc3","dvh1","dvhe","lhv1","lhe1"],r=["vc-1"],n=["vp08","vp8"],o=["vp09","vp9"],u=["av01"];if(t.includes(s))return G.avc;if(e.includes(s)||r.includes(s))return G.hevc;if(n.includes(s))return G.vp8;if(o.includes(s))return G.vp9;if(u.includes(s))return G.av1;throw new Error(`The MIME ${i} is not supported as video codec`)},Ce=(i,s,t)=>(s==5&&(s=j.BT_601),i==st.Unspecified&&s==j.Unspecified&&t==Se.RGB||[st.BT_601_625,st.BT_601_525].includes(i)?H.sdr:j.BT_2100_PQ===s?H.hdr10:j.BT_2100_HLG===s?H.hlg:H.sdr),Ie=({id:i,label:s,type:t,codec:e,dynamicRange:r,contentProtection:n,bitrate:o,duration:u,width:l,height:g,fps:m,language:p,segments:d})=>{let h=Te(Number(o)),T=Number(l),a=Number(g),D=u?Ae(Number(o),Number(u)):void 0;return{id:i,label:s,type:t,codec:e,bitrate:h,size:D,protection:n,segments:d,dynamicRange:r,language:p,width:T,height:a,fps:Number(m),quality:Ee({width:T,height:a}),toString(){return["VIDEO",`[${e}, ${r}]`,p,`${l}x${g} @ ${h.kbps} kb/s, ${m} FPS`].join(" | ")}}},De=i=>{for(let s of i.toLowerCase().split(",")){let t=s.trim().split(".")[0];try{return Re(t)}catch{continue}}throw new Error(`No MIME types matched any supported Video Codecs in ${i}`)},Ne=(i,s=[],t=[])=>{if(["dva1","dvav","dvhe","dvh1"].some(d=>i.startsWith(d)))return H.dv;let r="urn:mpeg:mpegB:cicp:ColourPrimaries",n="urn:mpeg:mpegB:cicp:TransferCharacteristics",o="urn:mpeg:mpegB:cicp:MatrixCoefficients",u=[...t,...s],l=d=>u.filter(h=>h.attributes.schemeIdUri===d).map(h=>parseInt(h.attributes.value)),g=l(r).reduce((d,h)=>d+h,0),m=l(n).reduce((d,h)=>d+h,0),p=l(o).reduce((d,h)=>d+h,0);return Ce(g,m,p)};Ct.exports={parseVideoCodec:De,parseDynamicRange:Ne,createVideoTrack:Ie,VIDEO_CODECS:G}});var k=O((Ps,Pt)=>{"use strict";var{getBestTrack:It}=x(),Oe=i=>i.toLowerCase().split(",").map(s=>s.trim().split(".")[0]),Dt=i=>({width:s,height:t})=>i.filter(e=>(!s||e.width===s)&&(!t||e.height===t)),at=i=>s=>{if(!s?.length)return i;let t=i.filter(e=>s.includes(e.codec));return t.sort((e,r)=>r.bitrate.bps-e.bitrate.bps),t},ve=i=>at(i),Nt=i=>s=>{if(!s)return[It(i)];let t=String(s).includes("p")?s:`${s}p`,e=i.filter(r=>r.quality===t);return e.sort((r,n)=>n.bitrate.bps-r.bitrate.bps),e.length?e:[It(i)]},Pe=i=>at(i),Ot=i=>(s=[],t)=>{if(!s.length)for(let o of i)s.includes(o.language)||s.push(o.language);let e=[];for(let o of s){let u=i.filter(l=>l.language?.startsWith(o));e.push(...u)}let r=[],n=[...new Set(e.map(o=>o.language))];for(let o of n){let u=e.filter(l=>l.language===o).slice(0,t);r.push(...u)}return r},vt=i=>s=>{if(!s)return i;let t=typeof s=="string"?parseFloat(s):s;return i.filter(e=>e.channels===t)},we=i=>s=>s.length?i.filter(t=>s.some(e=>t.language?.startsWith(e)||t.label?.startsWith(e))):i,Me=(i,s)=>Dt(i)(s),ye=(i,s)=>Nt(i)(s),Ue=(i,s)=>at(i)(s),Xe=(i,s,t)=>Ot(i)(s,t),Be=(i,s)=>vt(i)(s);Pt.exports={parseMimes:Oe,createResolutionFilter:Dt,createVideoCodecFilter:ve,createVideoQualityFilter:Nt,createAudioCodecFilter:Pe,createAudioLanguageFilter:Ot,createAudioChannelsFilter:vt,createSubtitleLanguageFilter:we,filterByResolution:Me,filterByQuality:ye,filterByCodecs:Ue,filterByLanguages:Xe,filterByChannels:Be}});var nt=O((ws,wt)=>{"use strict";var{parseMimes:Fe}=k(),{parseBitrate:_e,parseSize:Le}=x(),_={AAC:"AAC",AC3:"DD",EC3:"DD+",OPUS:"OPUS",OGG:"VORB",DTS:"DTS",ALAC:"ALAC",FLAC:"FLAC"},$e=i=>{switch(i.toLowerCase().trim().split(".")[0]){case"mp4a":return _.AAC;case"ac-3":return _.AC3;case"ec-3":return _.EC3;case"opus":return _.OPUS;case"dtsc":return _.DTS;case"alac":return _.ALAC;case"flac":return _.FLAC;default:throw new Error(`The MIME ${i} is not supported as audio codec`)}},xe=i=>{let s=Fe(i);for(let t of s)try{return $e(t)}catch{continue}throw new Error(`No MIME types matched any supported Audio Codecs in ${i}`)},Ge=(i=[])=>{let s="tag:dolby.com,2018:dash:EC3_ExtensionComplexityIndex:2018";for(let t of i)if(t.attributes.schemeIdUri===s)return parseInt(t.attributes.value)},Ve=(i=[])=>{for(let s of i){let{schemeIdUri:t,value:e}=s.attributes,r=t=="urn:mpeg:dash:role:2011"&&e==="descriptive",n=t=="urn:tva:metadata:cs:AudioPurposeCS:2007"&&e==="1";if(r||n)return!0}return!1},He=i=>{let s=t=>t>="0"&&t<="9";if(typeof i=="string"){if(i.toUpperCase()=="A000")return 2;if(i.toUpperCase()=="F801")return 5.1;if(s(i.replace("ch","").replace(".","")[0]))return parseFloat(i.replace("ch",""));throw new Error(`Unsupported audio channels value, \'${i}\'`)}return parseFloat(i)},ke=({id:i,label:s,type:t,codec:e,channels:r,bitrate:n,duration:o,jointObjectCoding:u=0,isDescriptive:l=!1,language:g,segments:m})=>{let p=_e(Number(n)),d=He(r),h=o?Le(Number(n),Number(o)):void 0;return{id:i,label:s,type:t,codec:e,bitrate:p,size:h,language:g,segments:m,channels:d,jointObjectCoding:u,isDescriptive:l,toString(){return["AUDIO",`[${e}]`,`${d||"?"}`+(u?` (JOC ${u})`:""),`${p.kbps} kb/s`,g].join(" | ")}}};wt.exports={AUDIO_CODECS:_,parseAudioCodec:xe,createAudioTrack:ke,getDolbyDigitalPlusComplexityIndex:Ge,checkIsDescriptive:Ve}});var yt=O((Ms,Mt)=>{"use strict";var{parseMimes:qe}=k(),{parseBitrate:Ye,parseSize:We}=x(),V={SubRip:"SRT",SubStationAlpha:"SSA",SubStationAlphav4:"ASS",TimedTextMarkupLang:"TTML",WebVTT:"VTT",fTTML:"STPP",fVTT:"WVTT"},Ke=i=>{switch(i.toLowerCase().trim().split(".")[0]){case"srt":case"x-subrip":return V.SubRip;case"ssa":return V.SubStationAlpha;case"ass":return V.SubStationAlphav4;case"ttml":return V.TimedTextMarkupLang;case"vtt":return V.WebVTT;case"stpp":return V.fTTML;case"wvtt":return V.fVTT;default:throw new Error(`The MIME ${i} is not supported as subtitle codec`)}},Qe=i=>{let s=qe(i);for(let t of s)try{return Ke(t)}catch{continue}throw new Error(`No MIME types matched any supported Subtitle Codecs in ${i}`)},je=(i=[])=>{for(let s of i)if(s.attributes.schemeIdUri==="urn:mpeg:dash:role:2011"&&s.attributes.value==="caption")return!0;return!1},ze=(i=[])=>{for(let s of i){let{schemeIdUri:t,value:e}=s.attributes;if(t==="urn:tva:metadata:cs:AudioPurposeCS:2007"&&e==="2")return!0}return!1},Je=(i=[])=>{for(let s of i)if(s.attributes.schemeIdUri==="urn:mpeg:dash:role:2011"&&(s.attributes.value==="forced-subtitle"||s.attributes.value==="forced_subtitle"))return!0;return!1},Ze=({id:i,label:s,bitrate:t,duration:e,type:r,codec:n,isClosedCaption:o,isSdh:u,isForced:l,language:g,segments:m})=>{let p=Ye(Number(t)),d=e?We(Number(t),Number(e)):void 0;return{id:i,label:s,bitrate:p,size:d,type:r,codec:n,isClosedCaption:o,isSdh:u,isForced:l,segments:m,language:g,toString(){return["SUBTITLE",`[${n}]`,g].join(" | ")}}};Mt.exports={parseSubtitleCodec:Qe,checkIsClosedCaption:je,checkIsSdh:ze,checkIsForced:Je,createSubtitleTrack:Ze}});var Xt=O((ys,Ut)=>{"use strict";var ti=Tt(),{parseDuration:ei,isLanguageTagValid:ii}=x(),{parseVideoCodec:si,parseDynamicRange:ri,createVideoTrack:ai}=rt(),{parseAudioCodec:ni,createAudioTrack:oi,getDolbyDigitalPlusComplexityIndex:ui,checkIsDescriptive:ci}=nt(),{parseSubtitleCodec:li,checkIsClosedCaption:fi,checkIsSdh:gi,checkIsForced:di,createSubtitleTrack:pi}=yt(),{createResolutionFilter:hi,createVideoQualityFilter:mi,createAudioLanguageFilter:bi,createSubtitleLanguageFilter:Ti,createVideoCodecFilter:Ei,createAudioCodecFilter:Ai,createAudioChannelsFilter:Si}=k(),z=i=>i&&(Array.isArray(i)?i.get=s=>z(i.find(t=>t.tagName===s)):(i.getAttr=s=>i.attributes[s],i.getChild=s=>{let t=i.children.find(r=>r.tagName===s);return!s&&typeof i.children?.[0]=="string"?i.children[0]:z(t)},i.set=(s,t)=>i.attributes[s]=t,i.get=s=>i.getAttr(s)||i.getChild(s),i.getNumber=s=>Number(i.find(s)),i.getAll=s=>i.children.filter(t=>t.tagName===s).map(z),i.getBaseUrls=()=>i.getAll("BaseURL").map(s=>s.children[0]),i.getBaseUrl=()=>i.getBaseUrls()[0]),i),Ri=(i,s)=>{let t=i.get,e=i.getAll,r=o=>t(o)||s.get(o),n=o=>[...e(o),...s.getAll(o)].filter(Boolean);return i.get=r,i.getAll=n,{get:r,getAll:n}},Ci=(i,s,t,e)=>{let r=s.getBaseUrl();return r?r.startsWith("https://")||(r=new URL(r,i).toString()):r=i,(t.getBaseUrl()||r)&&(r=new URL(t.getBaseUrl()||"",r).toString()),new URL(e.getBaseUrl()||"",r).toString()},Ii=i=>{let s=i.get("mimeType"),t=i.get("contentType")||s?.split("/")[0];if(!t&&!s)throw new Error("Unable to determine the format of a Representation, cannot continue...");return{contentType:t,mimeType:s}},Di=(i,s,t)=>s==="text"&&!t.includes("mp4")?t.split("/")[1]:i.get("codecs"),Ni=(i,s,t)=>{let e="",r=[],n=i.get("lang"),o=i.get("id");if(i&&(r.push(n),o)){let u=o.match(/\\w+_(\\w+)=\\d+/);u&&u[1]&&r.push(u[1])}r.push(s.get("lang")),t&&r.push(t);for(let u of r){let l=(u||"").trim();!ii(l)||l.startsWith("und")||(e=l)}return e},ot=(i,s)=>{let t=i;for(let[e,r]of Object.entries(s))t=t.replace("$"+e+"$",r);return t},Oi=(i,s,t)=>{for(let e of["initialization","media"]){let r=i.get(e);if(r){if(!r.startsWith("https://")){if(!s)throw new Error("Resolved Segment URL is not absolute, and no Base URL is available.");r=new URL(r,s).toString()}if(!new URL(r).search){let n=new URL(t).search;n&&(r+=`?${n}`)}i.set(e,r)}}},vi=(i,s,t,e)=>{let r=[],n=0;for(let l of i.getAll("S")){let g=Number(l.get("t")),m=Number(l.get("r")||0),p=Number(l.get("d"));g&&(n=g);for(let d=0;d<m+1;d++)r.push(n),n+=p}let o=[],u=[...Array(r.length).keys()].map(l=>l+e);for(let l=0;l<r.length;l++){let g=r[l],m=u[l],p=ot(s.get("media"),{Bandwidth:t.get("bandwidth"),RepresentationID:t.get("id"),Number:m,Time:g});o.push({url:p})}return o},Pi=(i,s,t,e,r)=>{let n=Number(i.get("startNumber")||1),o=i.get("SegmentTimeline");Oi(i,s,t);let u=parseFloat(i.get("duration")),l=parseFloat(i.get("timescale")||1),m=e?Math.ceil(e/(u/l)):35,p=r.get("bandwidth"),d=r.get("id"),h=[];if(o)h.push(...vi(o,i,r,n));else for(let a=n;a<n+m;a++){let D=ot(i.get("media"),{Bandwidth:p,RepresentationID:d,Number:a,Time:a});h.push({url:D})}let T=i.get("initialization");if(T){let a=ot(T,{Bandwidth:p,RepresentationID:d});h.unshift({url:a,init:!0})}return h},wi=(i,s)=>{let t=i.get("SegmentURL"),e=[];for(let r of t){let n=r.get("media");n?n.startsWith("https://")||(n=new URL(n,s).toString()):n=s,e.push({url:n,range:r.get("mediaRange")})}return e},Mi=async(i,s)=>{let t=i.get("Initialization");return{url:s,range:""}},yi=i=>{for(let s of i)if(s.url.includes("&amp;")){let e=new URL(s.url),r=new URLSearchParams(e.searchParams.toString()).entries();for(let[n,o]of r)e.searchParams.delete(n),e.searchParams.append(n.replaceAll("amp;",""),o);s.url=e.toString()}},Ui={"urn:mpeg:dash:mp4protection:2011":"common","urn:uuid:9a04f079-9840-4286-ab92-e65be0885f95":"playready","urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed":"widevine"},Xi=i=>{let s={};for(let t of i){let e=t.get("schemeIdUri")?.toLowerCase(),r=t.get("value"),n=t.get("cenc:pssh")?.get(),o=t.get("cenc:default_KID"),u={id:e,value:r,pssh:n,defaultKeyId:o};s[Ui[e]]=u}return s},Bi=async(i,s,t)=>{let e=z(ti.parse(i)).get("MPD"),r=e.get("Period"),n=r.get("duration")||e.get("mediaPresentationDuration"),o=ei(n),u=[],l=[],g=[];for(let m of r.getAll("AdaptationSet"))for(let p of m.getAll("Representation")){let{get:d,getAll:h}=Ri(p,m),{contentType:T,mimeType:a}=Ii(p),D=Di(p,T,a),C=Ni(p,m,t),f=Ci(s,e,r,p),c=d("SegmentTemplate"),E=d("SegmentList"),I=d("SegmentBase"),b=[];if(c){let w=Pi(c,f,s,o,p);b.push(...w)}else if(E){let w=wi(E,f);b.push(...w)}else if(I){let w=await Mi(I,f);b.push(w)}else if(f)b.push({url:f});else throw new Error("Could not find a way to get segments from this MPD manifest.");yi(b);let B=d("label"),M=d("frameRate")??I?.attributes.timescale,A=d("width")??0,S=d("height")??0,P=d("bandwidth"),U=h("SupplementalProperty"),$=h("EssentialProperty"),R=m.getAll("Accessibility"),y=m.getAll("Role"),F=h("ContentProtection"),N=[new URL(f).hostname,T,D,P,C,e.get("id"),r.get("id"),d("id"),d("audioTrackId")].filter(Boolean).join("-").replaceAll("/","-");switch(T){case"video":{let w=ai({id:N,label:B,type:T,codec:si(D),dynamicRange:ri(D,U,$),contentProtection:Xi(F),bitrate:P,duration:o,width:A,height:S,fps:M,language:C,segments:b});u.push(w);break}case"audio":{let w=oi({id:N,label:B,type:T,codec:ni(D),channels:d("AudioChannelConfiguration")?.get("value"),jointObjectCoding:ui(U),isDescriptive:ci(R),bitrate:P,duration:o,language:C,segments:b});l.push(w);break}case"text":{let w=pi({id:N,label:B,type:T,codec:li(D||"vtt"),isClosedCaption:fi(y),isSdh:gi(R),isForced:di(y),bitrate:P,duration:o,language:C,segments:b});g.push(w);break}case"image":break;default:throw new Error(`Unknown content type: ${T}`)}}return u.sort((m,p)=>p.bitrate.bps-m.bitrate.bps),{duration:o,tracks:{all:u.concat(l).concat(g),videos:u,audios:l,subtitles:g,withResolution:hi(u),withVideoCodecs:Ei(u),withVideoQuality:mi(u),withAudioCodecs:Ai(l),withAudioLanguages:bi(l),withAudioChannels:Si(l),withSubtitleLanguages:Ti(g)}}};Ut.exports={parseManifest:Bi}});var Ft=O((q,Bt)=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.default=void 0;var Fi=function(){function i(){this.listeners={}}var s=i.prototype;return s.on=function(e,r){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(r)},s.off=function(e,r){if(!this.listeners[e])return!1;var n=this.listeners[e].indexOf(r);return this.listeners[e]=this.listeners[e].slice(0),this.listeners[e].splice(n,1),n>-1},s.trigger=function(e){var r=this.listeners[e];if(r)if(arguments.length===2)for(var n=r.length,o=0;o<n;++o)r[o].call(this,arguments[1]);else for(var u=Array.prototype.slice.call(arguments,1),l=r.length,g=0;g<l;++g)r[g].apply(this,u)},s.dispose=function(){this.listeners={}},s.pipe=function(e){this.on("data",function(r){e.push(r)})},i}();q.default=Fi;Bt.exports=q.default});var _t=O((Us,X)=>{function ut(){return X.exports=ut=Object.assign?Object.assign.bind():function(i){for(var s=1;s<arguments.length;s++){var t=arguments[s];for(var e in t)({}).hasOwnProperty.call(t,e)&&(i[e]=t[e])}return i},X.exports.__esModule=!0,X.exports.default=X.exports,ut.apply(null,arguments)}X.exports=ut,X.exports.__esModule=!0,X.exports.default=X.exports});var Lt=O((Xs,Y)=>{function _i(i){return i&&i.__esModule?i:{default:i}}Y.exports=_i,Y.exports.__esModule=!0,Y.exports.default=Y.exports});var xt=O((Bs,$t)=>{var W;typeof window<"u"?W=window:typeof global<"u"?W=global:typeof self<"u"?W=self:W={};$t.exports=W});var Ht=O((J,Vt)=>{"use strict";var Li=Lt();Object.defineProperty(J,"__esModule",{value:!0});J.default=xi;var Gt=Li(xt()),$i=function(s){return Gt.default.atob?Gt.default.atob(s):Buffer.from(s,"base64").toString("binary")};function xi(i){for(var s=$i(i),t=new Uint8Array(s.length),e=0;e<s.length;e++)t[e]=s.charCodeAt(e);return t}Vt.exports=J.default});var qt=O(K=>{"use strict";Object.defineProperty(K,"__esModule",{value:!0});var Gi=Ft(),Vi=_t(),Hi=Ht();function gt(i){return i&&typeof i=="object"&&"default"in i?i:{default:i}}var dt=gt(Gi),Z=gt(Vi),ki=gt(Hi),tt=class extends dt.default{constructor(){super(),this.buffer=""}push(s){let t;for(this.buffer+=s,t=this.buffer.indexOf(`\n`);t>-1;t=this.buffer.indexOf(`\n`))this.trigger("data",this.buffer.substring(0,t)),this.buffer=this.buffer.substring(t+1)}},qi="	",ct=function(i){let s=/([0-9.]*)?@?([0-9.]*)?/.exec(i||""),t={};return s[1]&&(t.length=parseInt(s[1],10)),s[2]&&(t.offset=parseInt(s[2],10)),t},Yi=function(){let t="(?:"+"[^=]*"+")=(?:"+\'"[^"]*"|[^,]*\'+")";return new RegExp("(?:^|,)("+t+")")},v=function(i){let s={};if(!i)return s;let t=i.split(Yi()),e=t.length,r;for(;e--;)t[e]!==""&&(r=/([^=]*)=(.*)/.exec(t[e]).slice(1),r[0]=r[0].replace(/^\\s+|\\s+$/g,""),r[1]=r[1].replace(/^\\s+|\\s+$/g,""),r[1]=r[1].replace(/^[\'"](.*)[\'"]$/g,"$1"),s[r[0]]=r[1]);return s},kt=i=>{let s=i.split("x"),t={};return s[0]&&(t.width=parseInt(s[0],10)),s[1]&&(t.height=parseInt(s[1],10)),t},et=class extends dt.default{constructor(){super(),this.customParsers=[],this.tagMappers=[]}push(s){let t,e;if(s=s.trim(),s.length===0)return;if(s[0]!=="#"){this.trigger("data",{type:"uri",uri:s});return}this.tagMappers.reduce((n,o)=>{let u=o(s);return u===s?n:n.concat([u])},[s]).forEach(n=>{for(let o=0;o<this.customParsers.length;o++)if(this.customParsers[o].call(this,n))return;if(n.indexOf("#EXT")!==0){this.trigger("data",{type:"comment",text:n.slice(1)});return}if(n=n.replace("\\r",""),t=/^#EXTM3U/.exec(n),t){this.trigger("data",{type:"tag",tagType:"m3u"});return}if(t=/^#EXTINF:([0-9\\.]*)?,?(.*)?$/.exec(n),t){e={type:"tag",tagType:"inf"},t[1]&&(e.duration=parseFloat(t[1])),t[2]&&(e.title=t[2]),this.trigger("data",e);return}if(t=/^#EXT-X-TARGETDURATION:([0-9.]*)?/.exec(n),t){e={type:"tag",tagType:"targetduration"},t[1]&&(e.duration=parseInt(t[1],10)),this.trigger("data",e);return}if(t=/^#EXT-X-VERSION:([0-9.]*)?/.exec(n),t){e={type:"tag",tagType:"version"},t[1]&&(e.version=parseInt(t[1],10)),this.trigger("data",e);return}if(t=/^#EXT-X-MEDIA-SEQUENCE:(\\-?[0-9.]*)?/.exec(n),t){e={type:"tag",tagType:"media-sequence"},t[1]&&(e.number=parseInt(t[1],10)),this.trigger("data",e);return}if(t=/^#EXT-X-DISCONTINUITY-SEQUENCE:(\\-?[0-9.]*)?/.exec(n),t){e={type:"tag",tagType:"discontinuity-sequence"},t[1]&&(e.number=parseInt(t[1],10)),this.trigger("data",e);return}if(t=/^#EXT-X-PLAYLIST-TYPE:(.*)?$/.exec(n),t){e={type:"tag",tagType:"playlist-type"},t[1]&&(e.playlistType=t[1]),this.trigger("data",e);return}if(t=/^#EXT-X-BYTERANGE:(.*)?$/.exec(n),t){e=Z.default(ct(t[1]),{type:"tag",tagType:"byterange"}),this.trigger("data",e);return}if(t=/^#EXT-X-ALLOW-CACHE:(YES|NO)?/.exec(n),t){e={type:"tag",tagType:"allow-cache"},t[1]&&(e.allowed=!/NO/.test(t[1])),this.trigger("data",e);return}if(t=/^#EXT-X-MAP:(.*)$/.exec(n),t){if(e={type:"tag",tagType:"map"},t[1]){let o=v(t[1]);o.URI&&(e.uri=o.URI),o.BYTERANGE&&(e.byterange=ct(o.BYTERANGE))}this.trigger("data",e);return}if(t=/^#EXT-X-STREAM-INF:(.*)$/.exec(n),t){e={type:"tag",tagType:"stream-inf"},t[1]&&(e.attributes=v(t[1]),e.attributes.RESOLUTION&&(e.attributes.RESOLUTION=kt(e.attributes.RESOLUTION)),e.attributes.BANDWIDTH&&(e.attributes.BANDWIDTH=parseInt(e.attributes.BANDWIDTH,10)),e.attributes["FRAME-RATE"]&&(e.attributes["FRAME-RATE"]=parseFloat(e.attributes["FRAME-RATE"])),e.attributes["PROGRAM-ID"]&&(e.attributes["PROGRAM-ID"]=parseInt(e.attributes["PROGRAM-ID"],10))),this.trigger("data",e);return}if(t=/^#EXT-X-MEDIA:(.*)$/.exec(n),t){e={type:"tag",tagType:"media"},t[1]&&(e.attributes=v(t[1])),this.trigger("data",e);return}if(t=/^#EXT-X-ENDLIST/.exec(n),t){this.trigger("data",{type:"tag",tagType:"endlist"});return}if(t=/^#EXT-X-DISCONTINUITY/.exec(n),t){this.trigger("data",{type:"tag",tagType:"discontinuity"});return}if(t=/^#EXT-X-PROGRAM-DATE-TIME:(.*)$/.exec(n),t){e={type:"tag",tagType:"program-date-time"},t[1]&&(e.dateTimeString=t[1],e.dateTimeObject=new Date(t[1])),this.trigger("data",e);return}if(t=/^#EXT-X-KEY:(.*)$/.exec(n),t){e={type:"tag",tagType:"key"},t[1]&&(e.attributes=v(t[1]),e.attributes.IV&&(e.attributes.IV.substring(0,2).toLowerCase()==="0x"&&(e.attributes.IV=e.attributes.IV.substring(2)),e.attributes.IV=e.attributes.IV.match(/.{8}/g),e.attributes.IV[0]=parseInt(e.attributes.IV[0],16),e.attributes.IV[1]=parseInt(e.attributes.IV[1],16),e.attributes.IV[2]=parseInt(e.attributes.IV[2],16),e.attributes.IV[3]=parseInt(e.attributes.IV[3],16),e.attributes.IV=new Uint32Array(e.attributes.IV))),this.trigger("data",e);return}if(t=/^#EXT-X-START:(.*)$/.exec(n),t){e={type:"tag",tagType:"start"},t[1]&&(e.attributes=v(t[1]),e.attributes["TIME-OFFSET"]=parseFloat(e.attributes["TIME-OFFSET"]),e.attributes.PRECISE=/YES/.test(e.attributes.PRECISE)),this.trigger("data",e);return}if(t=/^#EXT-X-CUE-OUT-CONT:(.*)?$/.exec(n),t){e={type:"tag",tagType:"cue-out-cont"},t[1]?e.data=t[1]:e.data="",this.trigger("data",e);return}if(t=/^#EXT-X-CUE-OUT:(.*)?$/.exec(n),t){e={type:"tag",tagType:"cue-out"},t[1]?e.data=t[1]:e.data="",this.trigger("data",e);return}if(t=/^#EXT-X-CUE-IN:?(.*)?$/.exec(n),t){e={type:"tag",tagType:"cue-in"},t[1]?e.data=t[1]:e.data="",this.trigger("data",e);return}if(t=/^#EXT-X-SKIP:(.*)$/.exec(n),t&&t[1]){e={type:"tag",tagType:"skip"},e.attributes=v(t[1]),e.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(e.attributes["SKIPPED-SEGMENTS"]=parseInt(e.attributes["SKIPPED-SEGMENTS"],10)),e.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(e.attributes["RECENTLY-REMOVED-DATERANGES"]=e.attributes["RECENTLY-REMOVED-DATERANGES"].split(qi)),this.trigger("data",e);return}if(t=/^#EXT-X-PART:(.*)$/.exec(n),t&&t[1]){e={type:"tag",tagType:"part"},e.attributes=v(t[1]),["DURATION"].forEach(function(o){e.attributes.hasOwnProperty(o)&&(e.attributes[o]=parseFloat(e.attributes[o]))}),["INDEPENDENT","GAP"].forEach(function(o){e.attributes.hasOwnProperty(o)&&(e.attributes[o]=/YES/.test(e.attributes[o]))}),e.attributes.hasOwnProperty("BYTERANGE")&&(e.attributes.byterange=ct(e.attributes.BYTERANGE)),this.trigger("data",e);return}if(t=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(n),t&&t[1]){e={type:"tag",tagType:"server-control"},e.attributes=v(t[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach(function(o){e.attributes.hasOwnProperty(o)&&(e.attributes[o]=parseFloat(e.attributes[o]))}),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach(function(o){e.attributes.hasOwnProperty(o)&&(e.attributes[o]=/YES/.test(e.attributes[o]))}),this.trigger("data",e);return}if(t=/^#EXT-X-PART-INF:(.*)$/.exec(n),t&&t[1]){e={type:"tag",tagType:"part-inf"},e.attributes=v(t[1]),["PART-TARGET"].forEach(function(o){e.attributes.hasOwnProperty(o)&&(e.attributes[o]=parseFloat(e.attributes[o]))}),this.trigger("data",e);return}if(t=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(n),t&&t[1]){e={type:"tag",tagType:"preload-hint"},e.attributes=v(t[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach(function(o){if(e.attributes.hasOwnProperty(o)){e.attributes[o]=parseInt(e.attributes[o],10);let u=o==="BYTERANGE-LENGTH"?"length":"offset";e.attributes.byterange=e.attributes.byterange||{},e.attributes.byterange[u]=e.attributes[o],delete e.attributes[o]}}),this.trigger("data",e);return}if(t=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(n),t&&t[1]){e={type:"tag",tagType:"rendition-report"},e.attributes=v(t[1]),["LAST-MSN","LAST-PART"].forEach(function(o){e.attributes.hasOwnProperty(o)&&(e.attributes[o]=parseInt(e.attributes[o],10))}),this.trigger("data",e);return}if(t=/^#EXT-X-DATERANGE:(.*)$/.exec(n),t&&t[1]){e={type:"tag",tagType:"daterange"},e.attributes=v(t[1]),["ID","CLASS"].forEach(function(u){e.attributes.hasOwnProperty(u)&&(e.attributes[u]=String(e.attributes[u]))}),["START-DATE","END-DATE"].forEach(function(u){e.attributes.hasOwnProperty(u)&&(e.attributes[u]=new Date(e.attributes[u]))}),["DURATION","PLANNED-DURATION"].forEach(function(u){e.attributes.hasOwnProperty(u)&&(e.attributes[u]=parseFloat(e.attributes[u]))}),["END-ON-NEXT"].forEach(function(u){e.attributes.hasOwnProperty(u)&&(e.attributes[u]=/YES/i.test(e.attributes[u]))}),["SCTE35-CMD"," SCTE35-OUT","SCTE35-IN"].forEach(function(u){e.attributes.hasOwnProperty(u)&&(e.attributes[u]=e.attributes[u].toString(16))});let o=/^X-([A-Z]+-)+[A-Z]+$/;for(let u in e.attributes){if(!o.test(u))continue;let l=/[0-9A-Fa-f]{6}/g.test(e.attributes[u]),g=/^\\d+(\\.\\d+)?$/.test(e.attributes[u]);e.attributes[u]=l?e.attributes[u].toString(16):g?parseFloat(e.attributes[u]):String(e.attributes[u])}this.trigger("data",e);return}if(t=/^#EXT-X-INDEPENDENT-SEGMENTS/.exec(n),t){this.trigger("data",{type:"tag",tagType:"independent-segments"});return}if(t=/^#EXT-X-I-FRAMES-ONLY/.exec(n),t){this.trigger("data",{type:"tag",tagType:"i-frames-only"});return}if(t=/^#EXT-X-CONTENT-STEERING:(.*)$/.exec(n),t){e={type:"tag",tagType:"content-steering"},e.attributes=v(t[1]),this.trigger("data",e);return}if(t=/^#EXT-X-I-FRAME-STREAM-INF:(.*)$/.exec(n),t){e={type:"tag",tagType:"i-frame-playlist"},e.attributes=v(t[1]),e.attributes.URI&&(e.uri=e.attributes.URI),e.attributes.BANDWIDTH&&(e.attributes.BANDWIDTH=parseInt(e.attributes.BANDWIDTH,10)),e.attributes.RESOLUTION&&(e.attributes.RESOLUTION=kt(e.attributes.RESOLUTION)),e.attributes["AVERAGE-BANDWIDTH"]&&(e.attributes["AVERAGE-BANDWIDTH"]=parseInt(e.attributes["AVERAGE-BANDWIDTH"],10)),e.attributes["FRAME-RATE"]&&(e.attributes["FRAME-RATE"]=parseFloat(e.attributes["FRAME-RATE"])),this.trigger("data",e);return}if(t=/^#EXT-X-DEFINE:(.*)$/.exec(n),t){e={type:"tag",tagType:"define"},e.attributes=v(t[1]),this.trigger("data",e);return}this.trigger("data",{type:"tag",data:n.slice(4)})})}addParser({expression:s,customType:t,dataParser:e,segment:r}){typeof e!="function"&&(e=n=>n),this.customParsers.push(n=>{if(s.exec(n))return this.trigger("data",{type:"custom",data:e(n),customType:t,segment:r}),!0})}addTagMapper({expression:s,map:t}){let e=r=>s.test(r)?t(r):r;this.tagMappers.push(e)}},Wi=i=>i.toLowerCase().replace(/-(\\w)/g,s=>s[1].toUpperCase()),L=function(i){let s={};return Object.keys(i).forEach(function(t){s[Wi(t)]=i[t]}),s},lt=function(i){let{serverControl:s,targetDuration:t,partTargetDuration:e}=i;if(!s)return;let r="#EXT-X-SERVER-CONTROL",n="holdBack",o="partHoldBack",u=t&&t*3,l=e&&e*2;t&&!s.hasOwnProperty(n)&&(s[n]=u,this.trigger("info",{message:`${r} defaulting HOLD-BACK to targetDuration * 3 (${u}).`})),u&&s[n]<u&&(this.trigger("warn",{message:`${r} clamping HOLD-BACK (${s[n]}) to targetDuration * 3 (${u})`}),s[n]=u),e&&!s.hasOwnProperty(o)&&(s[o]=e*3,this.trigger("info",{message:`${r} defaulting PART-HOLD-BACK to partTargetDuration * 3 (${s[o]}).`})),e&&s[o]<l&&(this.trigger("warn",{message:`${r} clamping PART-HOLD-BACK (${s[o]}) to partTargetDuration * 2 (${l}).`}),s[o]=l)},ft=class extends dt.default{constructor(s={}){super(),this.lineStream=new tt,this.parseStream=new et,this.lineStream.pipe(this.parseStream),this.mainDefinitions=s.mainDefinitions||{},this.params=new URL(s.uri,"https://a.com").searchParams,this.lastProgramDateTime=null;let t=this,e=[],r={},n,o,u=!1,l=function(){},g={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},m="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",p=0;this.manifest={allowCache:!0,discontinuityStarts:[],dateRanges:[],iFramePlaylists:[],segments:[]};let d=0,h=0,T={};this.on("end",()=>{r.uri||!r.parts&&!r.preloadHints||(!r.map&&n&&(r.map=n),!r.key&&o&&(r.key=o),!r.timeline&&typeof p=="number"&&(r.timeline=p),this.manifest.preloadSegment=r)}),this.parseStream.on("data",function(a){let D,C;if(t.manifest.definitions){for(let f in t.manifest.definitions)if(a.uri&&(a.uri=a.uri.replace(`{$${f}}`,t.manifest.definitions[f])),a.attributes)for(let c in a.attributes)typeof a.attributes[c]=="string"&&(a.attributes[c]=a.attributes[c].replace(`{$${f}}`,t.manifest.definitions[f]))}({tag(){({version(){a.version&&(this.manifest.version=a.version)},"allow-cache"(){this.manifest.allowCache=a.allowed,"allowed"in a||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange(){let f={};"length"in a&&(r.byterange=f,f.length=a.length,"offset"in a||(a.offset=d)),"offset"in a&&(r.byterange=f,f.offset=a.offset),d=f.offset+f.length},endlist(){this.manifest.endList=!0},inf(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),a.title&&(r.title=a.title),a.duration>0&&(r.duration=a.duration),a.duration===0&&(r.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=e},key(){if(!a.attributes){this.trigger("warn",{message:"ignoring key declaration without attribute list"});return}if(a.attributes.METHOD==="NONE"){o=null;return}if(!a.attributes.URI){this.trigger("warn",{message:"ignoring key declaration without URI"});return}if(a.attributes.KEYFORMAT==="com.apple.streamingkeydelivery"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:a.attributes};return}if(a.attributes.KEYFORMAT==="com.microsoft.playready"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.microsoft.playready"]={uri:a.attributes.URI};return}if(a.attributes.KEYFORMAT===m){if(["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(a.attributes.METHOD)===-1){this.trigger("warn",{message:"invalid key method provided for Widevine"});return}if(a.attributes.METHOD==="SAMPLE-AES-CENC"&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),a.attributes.URI.substring(0,23)!=="data:text/plain;base64,"){this.trigger("warn",{message:"invalid key URI provided for Widevine"});return}if(!(a.attributes.KEYID&&a.attributes.KEYID.substring(0,2)==="0x")){this.trigger("warn",{message:"invalid key ID provided for Widevine"});return}this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:a.attributes.KEYFORMAT,keyId:a.attributes.KEYID.substring(2)},pssh:ki.default(a.attributes.URI.split(",")[1])};return}a.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),o={method:a.attributes.METHOD||"AES-128",uri:a.attributes.URI},typeof a.attributes.IV<"u"&&(o.iv=a.attributes.IV)},"media-sequence"(){if(!isFinite(a.number)){this.trigger("warn",{message:"ignoring invalid media sequence: "+a.number});return}this.manifest.mediaSequence=a.number},"discontinuity-sequence"(){if(!isFinite(a.number)){this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+a.number});return}this.manifest.discontinuitySequence=a.number,p=a.number},"playlist-type"(){if(!/VOD|EVENT/.test(a.playlistType)){this.trigger("warn",{message:"ignoring unknown playlist type: "+a.playlist});return}this.manifest.playlistType=a.playlistType},map(){n={},a.uri&&(n.uri=a.uri),a.byterange&&(n.byterange=a.byterange),o&&(n.key=o)},"stream-inf"(){if(this.manifest.playlists=e,this.manifest.mediaGroups=this.manifest.mediaGroups||g,!a.attributes){this.trigger("warn",{message:"ignoring empty stream-inf attributes"});return}r.attributes||(r.attributes={}),Z.default(r.attributes,a.attributes)},media(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||g,!(a.attributes&&a.attributes.TYPE&&a.attributes["GROUP-ID"]&&a.attributes.NAME)){this.trigger("warn",{message:"ignoring incomplete or missing media group"});return}let f=this.manifest.mediaGroups[a.attributes.TYPE];f[a.attributes["GROUP-ID"]]=f[a.attributes["GROUP-ID"]]||{},D=f[a.attributes["GROUP-ID"]],C={default:/yes/i.test(a.attributes.DEFAULT)},C.default?C.autoselect=!0:C.autoselect=/yes/i.test(a.attributes.AUTOSELECT),a.attributes.LANGUAGE&&(C.language=a.attributes.LANGUAGE),a.attributes.URI&&(C.uri=a.attributes.URI),a.attributes["INSTREAM-ID"]&&(C.instreamId=a.attributes["INSTREAM-ID"]),a.attributes.CHARACTERISTICS&&(C.characteristics=a.attributes.CHARACTERISTICS),a.attributes.FORCED&&(C.forced=/yes/i.test(a.attributes.FORCED)),D[a.attributes.NAME]=C},discontinuity(){p+=1,r.discontinuity=!0,this.manifest.discontinuityStarts.push(e.length)},"program-date-time"(){typeof this.manifest.dateTimeString>"u"&&(this.manifest.dateTimeString=a.dateTimeString,this.manifest.dateTimeObject=a.dateTimeObject),r.dateTimeString=a.dateTimeString,r.dateTimeObject=a.dateTimeObject;let{lastProgramDateTime:f}=this;this.lastProgramDateTime=new Date(a.dateTimeString).getTime(),f===null&&this.manifest.segments.reduceRight((c,E)=>(E.programDateTime=c-E.duration*1e3,E.programDateTime),this.lastProgramDateTime)},targetduration(){if(!isFinite(a.duration)||a.duration<0){this.trigger("warn",{message:"ignoring invalid target duration: "+a.duration});return}this.manifest.targetDuration=a.duration,lt.call(this,this.manifest)},start(){if(!a.attributes||isNaN(a.attributes["TIME-OFFSET"])){this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"});return}this.manifest.start={timeOffset:a.attributes["TIME-OFFSET"],precise:a.attributes.PRECISE}},"cue-out"(){r.cueOut=a.data},"cue-out-cont"(){r.cueOutCont=a.data},"cue-in"(){r.cueIn=a.data},skip(){this.manifest.skip=L(a.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",a.attributes,["SKIPPED-SEGMENTS"])},part(){u=!0;let f=this.manifest.segments.length,c=L(a.attributes);r.parts=r.parts||[],r.parts.push(c),c.byterange&&(c.byterange.hasOwnProperty("offset")||(c.byterange.offset=h),h=c.byterange.offset+c.byterange.length);let E=r.parts.length-1;this.warnOnMissingAttributes_(`#EXT-X-PART #${E} for segment #${f}`,a.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((I,b)=>{I.hasOwnProperty("lastPart")||this.trigger("warn",{message:`#EXT-X-RENDITION-REPORT #${b} lacks required attribute(s): LAST-PART`})})},"server-control"(){let f=this.manifest.serverControl=L(a.attributes);f.hasOwnProperty("canBlockReload")||(f.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),lt.call(this,this.manifest),f.canSkipDateranges&&!f.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint"(){let f=this.manifest.segments.length,c=L(a.attributes),E=c.type&&c.type==="PART";r.preloadHints=r.preloadHints||[],r.preloadHints.push(c),c.byterange&&(c.byterange.hasOwnProperty("offset")||(c.byterange.offset=E?h:0,E&&(h=c.byterange.offset+c.byterange.length)));let I=r.preloadHints.length-1;if(this.warnOnMissingAttributes_(`#EXT-X-PRELOAD-HINT #${I} for segment #${f}`,a.attributes,["TYPE","URI"]),!!c.type)for(let b=0;b<r.preloadHints.length-1;b++){let B=r.preloadHints[b];B.type&&B.type===c.type&&this.trigger("warn",{message:`#EXT-X-PRELOAD-HINT #${I} for segment #${f} has the same TYPE ${c.type} as preload hint #${b}`})}},"rendition-report"(){let f=L(a.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(f);let c=this.manifest.renditionReports.length-1,E=["LAST-MSN","URI"];u&&E.push("LAST-PART"),this.warnOnMissingAttributes_(`#EXT-X-RENDITION-REPORT #${c}`,a.attributes,E)},"part-inf"(){this.manifest.partInf=L(a.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",a.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),lt.call(this,this.manifest)},daterange(){this.manifest.dateRanges.push(L(a.attributes));let f=this.manifest.dateRanges.length-1;this.warnOnMissingAttributes_(`#EXT-X-DATERANGE #${f}`,a.attributes,["ID","START-DATE"]);let c=this.manifest.dateRanges[f];c.endDate&&c.startDate&&new Date(c.endDate)<new Date(c.startDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE END-DATE must be equal to or later than the value of the START-DATE"}),c.duration&&c.duration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE DURATION must not be negative"}),c.plannedDuration&&c.plannedDuration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE PLANNED-DURATION must not be negative"});let E=!!c.endOnNext;if(E&&!c.class&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must have a CLASS attribute"}),E&&(c.duration||c.endDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must not contain DURATION or END-DATE attributes"}),c.duration&&c.endDate){let b=c.startDate.getTime()+c.duration*1e3;this.manifest.dateRanges[f].endDate=new Date(b)}if(!T[c.id])T[c.id]=c;else{for(let b in T[c.id])if(c[b]&&JSON.stringify(T[c.id][b])!==JSON.stringify(c[b])){this.trigger("warn",{message:"EXT-X-DATERANGE tags with the same ID in a playlist must have the same attributes values"});break}let I=this.manifest.dateRanges.findIndex(b=>b.id===c.id);this.manifest.dateRanges[I]=Z.default(this.manifest.dateRanges[I],c),T[c.id]=Z.default(T[c.id],c),this.manifest.dateRanges.pop()}},"independent-segments"(){this.manifest.independentSegments=!0},"i-frames-only"(){this.manifest.iFramesOnly=!0,this.requiredCompatibilityversion(this.manifest.version,4)},"content-steering"(){this.manifest.contentSteering=L(a.attributes),this.warnOnMissingAttributes_("#EXT-X-CONTENT-STEERING",a.attributes,["SERVER-URI"])},define(){this.manifest.definitions=this.manifest.definitions||{};let f=(c,E)=>{if(c in this.manifest.definitions){this.trigger("error",{message:`EXT-X-DEFINE: Duplicate name ${c}`});return}this.manifest.definitions[c]=E};if("QUERYPARAM"in a.attributes){if("NAME"in a.attributes||"IMPORT"in a.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}let c=this.params.get(a.attributes.QUERYPARAM);if(!c){this.trigger("error",{message:`EXT-X-DEFINE: No query param ${a.attributes.QUERYPARAM}`});return}f(a.attributes.QUERYPARAM,decodeURIComponent(c));return}if("NAME"in a.attributes){if("IMPORT"in a.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}if(!("VALUE"in a.attributes)||typeof a.attributes.VALUE!="string"){this.trigger("error",{message:`EXT-X-DEFINE: No value for ${a.attributes.NAME}`});return}f(a.attributes.NAME,a.attributes.VALUE);return}if("IMPORT"in a.attributes){if(!this.mainDefinitions[a.attributes.IMPORT]){this.trigger("error",{message:`EXT-X-DEFINE: No value ${a.attributes.IMPORT} to import, or IMPORT used on main playlist`});return}f(a.attributes.IMPORT,this.mainDefinitions[a.attributes.IMPORT]);return}this.trigger("error",{message:"EXT-X-DEFINE: No attribute"})},"i-frame-playlist"(){this.manifest.iFramePlaylists.push({attributes:a.attributes,uri:a.uri,timeline:p}),this.warnOnMissingAttributes_("#EXT-X-I-FRAME-STREAM-INF",a.attributes,["BANDWIDTH","URI"])}}[a.tagType]||l).call(t)},uri(){r.uri=a.uri,e.push(r),this.manifest.targetDuration&&!("duration"in r)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),r.duration=this.manifest.targetDuration),o&&(r.key=o),r.timeline=p,n&&(r.map=n),h=0,this.lastProgramDateTime!==null&&(r.programDateTime=this.lastProgramDateTime,this.lastProgramDateTime+=r.duration*1e3),r={}},comment(){},custom(){a.segment?(r.custom=r.custom||{},r.custom[a.customType]=a.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[a.customType]=a.data)}})[a.type].call(t)})}requiredCompatibilityversion(s,t){(s<t||!s)&&this.trigger("warn",{message:`manifest must be at least version ${t}`})}warnOnMissingAttributes_(s,t,e){let r=[];e.forEach(function(n){t.hasOwnProperty(n)||r.push(n)}),r.length&&this.trigger("warn",{message:`${s} lacks required attribute(s): ${r.join(", ")}`})}push(s){this.lineStream.push(s)}end(){this.lineStream.push(`\n`),this.manifest.dateRanges.length&&this.lastProgramDateTime===null&&this.trigger("warn",{message:"A playlist with EXT-X-DATERANGE tag must contain atleast one EXT-X-PROGRAM-DATE-TIME tag"}),this.lastProgramDateTime=null,this.trigger("end")}addParser(s){this.parseStream.addParser(s)}addTagMapper(s){this.parseStream.addTagMapper(s)}};K.LineStream=tt;K.ParseStream=et;K.Parser=ft});var zt=O((_s,jt)=>{"use strict";var{dirname:Ki,basename:Yt}=ne("node:path"),Qi=qt(),{parseBitrate:ji,getQualityLabel:zi}=x(),{createResolutionFilter:Ji,createVideoQualityFilter:Zi,createAudioLanguageFilter:ts,createSubtitleLanguageFilter:es,createVideoCodecFilter:is,createAudioCodecFilter:ss,createAudioChannelsFilter:rs}=k(),{createAudioTrack:as}=nt(),{createVideoTrack:ns}=rt(),Wt=i=>{let s=new Qi.Parser;return s.push(i),s.end(),s.manifest},os=async i=>fetch(i).then(s=>s.text()).then(Wt),Kt=(i,s)=>{let t=i;return t.startsWith("https://")||(t=new URL(t,s).toString()),t},us=(i,s)=>new URL(i).pathname===new URL(s).pathname,Qt=(i,s)=>{let t=[];if(!i)return t;for(let[e,r]of Object.entries(i))for(let[n,o]of Object.entries(r)){let u=Kt(o.uri,s);t.find(g=>us(g.url,u))||t.push({groupId:e,label:n,language:o.language,url:u})}return t},cs=(i,s)=>i.mediaGroups?Qt(i.mediaGroups.AUDIO,s):[],ls=(i,s)=>i.mediaGroups?Qt(i.mediaGroups.SUBTITLES,s):[],fs=(i,s)=>i.playlists?i.playlists.map(t=>{let e=t.attributes?.BANDWIDTH,r=t.resolvedUri||Kt(t.uri,s),n={bitrate:ji(e),url:r};return n.type="video",t.attributes.RESOLUTION&&(n.resolution=t.attributes.RESOLUTION,n.quality=zi(n.resolution)),t.attributes.CODECS&&(n.codecs=t.attributes.CODECS),t.attributes["FRAME-RATE"]&&(n.frameRate=t.attributes["FRAME-RATE"]),n}):[],gs=(i=[],s)=>{let t=r=>{let n=r.resolvedUri||r.uri;if(!n.startsWith("https://")){let o=Ki(s.url)+"/";n=new URL(n,o).toString()}return{url:n,duration:r.duration,number:r.number,presentationTime:r.presentationTime}},e=i.map(t);return i.length&&i[0].map?.resolvedUri&&e.unshift({url:i[0].map.resolvedUri,init:!0,duration:0,number:0,presentationTime:0}),e},ht=(i,s)=>{if(s.segments=gs(i.segments,s),i.contentProtection){s.protection={};let t=i.contentProtection["com.apple.fps.1_0"];t&&(s.protection.fairplay={keyFormat:t.attributes.KEYFORMAT,uri:t.attributes.URI,method:t.attributes.METHOD})}},pt=i=>Promise.all(i.map(async s=>{let t=await os(s.url);ht(t,s)})),ds=async(i,s)=>{let t=Wt(i),e=fs(t,s),r=cs(t,s),n=ls(t,s);if(!t.playlists&&t.segments){let{pathname:u}=new URL(s);if(u.includes(".m4a")||u.includes(".mp3")||u.includes(".opus")){let g=as({id:"audio"+Yt(u),label:"audio",type:"audio",codec:"",channels:2,jointObjectCoding:"",isDescriptive:!1,bitrate:NaN,duration:NaN,language:""});ht(t,g),r.push(g)}else{let g=ns({id:"video"+Yt(u),label:"video",type:"video",codec:"",dynamicRange:"",contentProtection:"",bitrate:NaN,duration:NaN,width:NaN,height:NaN,fps:NaN,language:""});ht(t,g),e.push(g)}}else await Promise.all([pt(e),pt(r),pt(n)]);return{tracks:{all:e.concat(r).concat(n),videos:e,audios:r,subtitles:n,withResolution:Ji(e),withVideoCodecs:is(e),withVideoQuality:Zi(e),withAudioCodecs:ss(r),withAudioLanguages:ts(r),withAudioChannels:rs(r),withSubtitleLanguages:es(n)}}};jt.exports={parseManifest:ds}});var Zt=O((Ls,Jt)=>{"use strict";var ps=Xt(),hs=zt(),{filterByResolution:ms,filterByQuality:bs,filterByCodecs:Ts,filterByLanguages:Es,filterByChannels:As}=k(),Ss=(i,s,t)=>{if(i.includes("<MPD"))return ps.parseManifest(i,s,t);if(i.includes("#EXTM3U"))return hs.parseManifest(i,s);throw new Error("Invalid manifest")};Jt.exports={parse:Ss,filterByResolution:ms,filterByQuality:bs,filterByCodecs:Ts,filterByLanguages:Es,filterByChannels:As}});var Is={};oe(Is,{parseDasha:()=>Cs});var te=ue(Zt()),Rs=i=>JSON.parse(JSON.stringify(i)),Cs=async(...i)=>Rs(await(0,te.parse)(...i));return ce(Is);})();\n/*! Bundled license information:\n\nm3u8-parser/dist/m3u8-parser.cjs.js:\n  (*! @name m3u8-parser @version 7.2.0 @license Apache-2.0 *)\n*/\n',"neptuneExports");var mt=r=>(...e)=>window.electron.ipcRenderer.invoke("___lib/native/dasha.native.ts",r,...e).catch(t=>{let i=t.stack?.replaceAll("Error invoking remote method '___lib/native/dasha.native.ts': Error: ","");throw new Error(`[_lib/native/dasha.native.ts.${r}] ${i}`)}),Ie=mt("parseDasha");var Ae=ve("getCredentials","function");if(Ae===void 0)throw new Error("getCredentials method not found");var B=class{static _store=new x("PlaybackInfoCache",{storeSchema:{keyPath:["playbackInfo.trackId","playbackInfo.audioQuality"]}});static _sema=new E(1);static async ensure(e,t){if(!F.includes(t))throw new Error(`Cannot get Stream Info! Invalid audio quality: ${t}, should be one of ${F.join(", ")}`);if(e===void 0)throw new Error("Cannot get Stream Info! trackId is missing");let i=await this._store.get([e,t]);return i!==void 0?i:this.update(e,t)}static async update(e,t){let i=await this._sema.obtain();try{let a=`https://desktop.tidal.com/v1/tracks/${e}/playbackinfo?audioquality=${t}&playbackmode=STREAM&assetpresentation=FULL`,{clientId:s,token:n}=await Ae(),o=await fetch(a,{headers:{Authorization:`Bearer ${n}`,"x-tidal-token":s}}).then(u=>{if(u.status===401)throw alert("Failed to fetch Stream Info... Invalid OAuth Access Token!"),new Error("Invalid OAuth Access Token!");return u.json()});switch(o.manifestMimeType){case"application/vnd.tidal.bts":{let u=JSON.parse(atob(o.manifest)),l={playbackInfo:o,manifestMimeType:o.manifestMimeType,manifest:u},m=new URL(u.urls[0]).searchParams.get("Expires");return m!==null&&this._store.putExpires(l,+m*1e3),l}case"application/dash+xml":{let u=await Ie(atob(o.manifest),"https://sp-ad-cf.audio.tidal.com");return{playbackInfo:o,manifestMimeType:o.manifestMimeType,manifest:u}}default:throw new Error(`Unsupported Stream Info manifest mime type: ${o.manifestMimeType}`)}}catch(a){throw new Error(`Failed to decode Stream Info! ${a?.message}`)}finally{i()}}};var ft=NeptuneNative.createEvalScope(`
						electron.ipcMain.removeHandler("__Testing/src/electron.native.ts_registerExports");
						electron.ipcMain.handle("__Testing/src/electron.native.ts_registerExports", (_, code, globalName) => {
							const exports = eval(\`(() => {\${code};return \${globalName};})()\`)
							electron.ipcMain.removeHandler("__Testing/src/electron.native.ts");
							electron.ipcMain.handle("__Testing/src/electron.native.ts", (_, exportName, ...args) => exports[exportName](...args));
						});
					`);NeptuneNative.deleteEvalScope(ft);await window.electron.ipcRenderer.invoke("__Testing/src/electron.native.ts_registerExports",`"use strict";var neptuneExports=(()=>{var g=Object.defineProperty;var s=Object.getOwnPropertyDescriptor;var t=Object.getOwnPropertyNames;var n=Object.prototype.hasOwnProperty;var r=(o=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(o,{get:(a,e)=>(typeof require<"u"?require:a)[e]}):o)(function(o){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+o+'" is not supported')});var D=(o,a)=>{for(var e in a)g(o,e,{get:a[e],enumerable:!0})},c=(o,a,e,p)=>{if(a&&typeof a=="object"||typeof a=="function")for(let i of t(a))!n.call(o,i)&&i!==e&&g(o,i,{get:()=>a[i],enumerable:!(p=s(a,i))||p.enumerable});return o};var h=o=>c(g({},"__esModule",{value:!0}),o);var w={};D(w,{openDialog:()=>m,saveDialog:()=>v});var l=r("electron"),m=l.dialog.showOpenDialog,v=l.dialog.showSaveDialog;return h(w);})();
`,"neptuneExports");var Se=r=>(...e)=>window.electron.ipcRenderer.invoke("__Testing/src/electron.native.ts",r,...e).catch(t=>{let i=t.stack?.replaceAll("Error invoking remote method '__Testing/src/electron.native.ts': Error: ","");throw new Error(`[Testing/src/electron.native.ts.${r}] ${i}`)}),xe=Se("openDialog"),Re=Se("saveDialog");var ht=NeptuneNative.createEvalScope(`
						electron.ipcMain.removeHandler("___lib/native/downloadTrack.native.ts_registerExports");
						electron.ipcMain.handle("___lib/native/downloadTrack.native.ts_registerExports", (_, code, globalName) => {
							const exports = eval(\`(() => {\${code};return \${globalName};})()\`)
							electron.ipcMain.removeHandler("___lib/native/downloadTrack.native.ts");
							electron.ipcMain.handle("___lib/native/downloadTrack.native.ts", (_, exportName, ...args) => exports[exportName](...args));
						});
					`);NeptuneNative.deleteEvalScope(ht);await window.electron.ipcRenderer.invoke("___lib/native/downloadTrack.native.ts_registerExports",'"use strict";var neptuneExports=(()=>{var ae=Object.create;var A=Object.defineProperty;var se=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var de=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty;var g=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error(\'Dynamic require of "\'+t+\'" is not supported\')});var he=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),le=(t,e)=>{for(var r in e)A(t,r,{get:e[r],enumerable:!0})},W=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of ce(e))!me.call(t,o)&&o!==r&&A(t,o,{get:()=>e[o],enumerable:!(n=se(e,o))||n.enumerable});return t};var H=(t,e,r)=>(r=t!=null?ae(de(t)):{},W(e||!t||!t.__esModule?A(r,"default",{value:t,enumerable:!0}):r,t)),ue=t=>W(A({},"__esModule",{value:!0}),t);var te=he((ct,ee)=>{function X(t,e,r){if(t.readUInt32)return t.readUInt32(e,r);var n;if(r){if(t.readUInt32BE)return t.readUInt32BE(e);n=(t[e]<<24)+(t[e+1]<<16)+(t[e+2]<<8)+t[e+3]}else{if(t.readUInt32LE)return t.readUInt32LE(e);n=t[e]+(t[e+1]<<8)+(t[e+2]<<16)+(t[e+3]<<24)}return n}function B(t,e,r){if(t.readUInt16)return t.readUInt16(e,r);var n;if(r){if(t.readUInt16BE)return t.readUInt16BE(e);n=(t[e]<<8)+t[e+1]}else{if(t.readUInt16LE)return t.readUInt16LE(e);n=t[e]+(t[e+1]<<8)}return n}function Y(t,e,r){r>7&&(e+=Math.floor(r/8),r=r%8);var n=t[e];r<7&&(n>>>=7-r);var o=n&1;return o}function M(t,e,r,n,o){var i=0,a=!1;o&&(Y(t,e,r)>0&&(a=!0),n--,r++);for(var c=[],s=0;s<n;s++){var d=Y(t,e,r+s);s>0&&(n-s)%8==0&&(c.push(i),i=0),i<<=1,i|=d}return c.push(i),i=new Buffer(c),i.negative=!!a,i}function Le(t){var e=[73,72,68,82],r=12;return E(t,r,e)?(r+=4,{type:"image",format:"PNG",mimeType:"image/png",width:X(t,r,!0),height:X(t,r+4,!0)}):!1}function Ee(t){for(var e=2,r=t.length,n=[255,[192,194]];e<r;){if(E(t,e,n))return e+=5,{type:"image",format:"JPG",mimeType:"image/jpeg",width:B(t,e+2,!0),height:B(t,e,!0)};e+=2;var o=B(t,e,!0);e+=o}}function Ie(t){var e=6;return{type:"image",format:"GIF",mimeType:"image/gif",width:B(t,e,!1),height:B(t,e+2,!1)}}function Se(t){var e=8,r=0,n;if(t[0]===67)try{t=g("zlib").inflate(t.slice(8,100)),e=0}catch{return{type:"flash",format:"SWF",mimeType:"application/x-shockwave-flash",width:null,height:null}}var o=M(t,e,r,5)[0];r+=5,n=M(t,e,r,o,!0);var i=(o>9?B(n,0,!0):n[0])*(n.negative?-1:1);r+=o,n=M(t,e,r,o,!0);var a=(o>9?B(n,0,!0):n[0])*(n.negative?-1:1);r+=o,n=M(t,e,r,o,!0);var c=(o>9?B(n,0,!0):n[0])*(n.negative?-1:1);r+=o,n=M(t,e,r,o,!0);var s=(o>9?B(n,0,!0):n[0])*(n.negative?-1:1);return{type:"flash",format:"SWF",mimeType:"application/x-shockwave-flash",width:Math.ceil((a-i)/20),height:Math.ceil((s-c)/20)}}function E(t,e,r){for(var n=r.length,o=0;o<n;o++){var i=t[o+e],a=r[o],c=!1;if(typeof a=="number")c=a===i;else for(var s in a){var d=a[s];d===i&&(c=!0)}if(!c)return!1}return!0}ee.exports=function(e,r){var n=[137,80,78,71,13,10,26,10],o=[255,216,255],i=[71,73,70,56,[55,57],97],a=[[70,67],87,83];return E(e,0,n)?Le(e):E(e,0,o)?Ee(e):E(e,0,i)?Ie(e):E(e,0,a)?Se(e):!1}});var Re={};le(Re,{getDownloadProgress:()=>Ce,startTrackDownload:()=>De});var G=g("electron"),S=(t,...e)=>{for(let r of G.BrowserWindow.getAllWindows())r.webContents.send(t,...e)};var fe=t=>{let e=a=>{let c=(...s)=>{a(t,...s)};return c.withContext=s=>(...d)=>{a(t,s,...d)},c},r=e((...a)=>S("NEPTUNE_RENDERER_LOG","log",...a)),n=e((...a)=>S("NEPTUNE_RENDERER_LOG","warn",...a)),o=e((...a)=>S("NEPTUNE_RENDERER_LOG","error",...a)),i=e((...a)=>S("NEPTUNE_RENDERER_LOG","debug",...a));return{log:r,warn:n,err:o,debug:i}},v=fe("[lib.native]");var k=t=>{if(!(t.statusCode!==void 0&&t.statusCode>=200&&t.statusCode<300))throw pe(t).then(r=>v.err(`(${t.statusCode})`,r,t.url)).catch(()=>{}),new Error(`Status code is ${t.statusCode}`);return t},pe=t=>F(t).then(e=>JSON.parse(e.toString())),F=t=>new Promise((e,r)=>{let n=[];t.on("data",o=>n.push(o)),t.on("end",()=>e(Buffer.concat(n))),t.on("error",r)});var b=t=>{if(t["content-range"]){let e=/\\/(\\d+)$/.exec(t["content-range"]);if(e)return parseInt(e[1],10)}else if(t["content-length"]!==void 0)return parseInt(t["content-length"],10);return-1};var K=g("https");var $=class{constructor(e){this.avalibleSlots=e}queued=[];async obtain(){let e=!1,r=()=>{e||(e=!0,this.avalibleSlots++,this.queued.shift()?.())};return this.avalibleSlots>0?(this.avalibleSlots--,r):new Promise(n=>{this.queued.push(()=>{this.avalibleSlots--,n(r)})})}};var ge="Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) TIDAL/9999.9999.9999 Chrome/126.0.6478.127 Electron/31.2.1 Safari/537.36";var ye=new $(1),w=async(t,e={})=>{let r=Date.now();e.headers??={},e.headers["user-agent"]=ge,e.rateLimit??=0;let n=e.rateLimit>0?await ye.obtain():void 0;return new Promise((o,i)=>{let a=e.body;delete e.body,a!==void 0&&(e.headers??={},e.headers["Content-Length"]=Buffer.byteLength(a));let c=(0,K.request)(t,e,s=>{s.url=t;let d=s.statusMessage!==""?` - ${s.statusMessage}`:"";if(s.statusCode===429||s.statusCode===503){let h=parseInt(s.headers["retry-after"]??"1",10);return e.rateLimit++,v.debug(`[${s.statusCode}${d}] (${c.method} - ${Date.now()-r}ms)`,`[Attempt ${e.rateLimit}, Retry in ${h}s]`,t),setTimeout(()=>{n?.(),w(t,e).then(o,i)},h)}e.rateLimit>0?v.debug(`[${s.statusCode}${d}] (${c.method} - ${Date.now()-r}ms)`,`[After ${e.rateLimit} attempts]`,t):v.debug(`[${s.statusCode}${d}] (${c.method} - ${Date.now()-r}ms)`,t),o(s)});c.on("error",i),a!==void 0&&c.write(a),c.end()}).finally(n)};var j=g("stream");var _=g("crypto"),Be="UIlTTEMmmLfGowo/UC60x2H45W6MdGgTRfo/umg4754=",we=Buffer.from(Be,"base64"),xe=t=>{let e=Buffer.from(t,"base64"),r=e.subarray(0,16),n=e.subarray(16),i=(0,_.createDecipheriv)("aes-256-cbc",Uint8Array.from(we),Uint8Array.from(r)).update(Uint8Array.from(n)),a=i.subarray(0,16),c=i.subarray(16,24);return{key:a,nonce:c}},ke=({key:t,nonce:e})=>{let r=new Uint8Array([...e,...new Uint8Array(8)]);return(0,_.createDecipheriv)("aes-128-ctr",Uint8Array.from(t),r)},V=t=>{switch(t.encryptionType){case"OLD_AES":return ke(xe(t.keyId));case"NONE":return;default:throw new Error(`Unexpected manifest encryption type ${t.encryptionType}`)}};var J=async(t,e)=>new Promise(async(r,n)=>{let{onProgress:o,bytesWanted:i,manifest:a}=e??{},c={...e?.requestOptions??{}};i!==void 0&&(c.headers??={},c.headers.Range=`bytes=0-${i}`);let s=await w(t,c).then(k);s.on("error",n);let d=0,h=b(s.headers);h!==-1&&o?.({total:h,downloaded:d,percent:d/h*100});let m=a?V(a):void 0;m!==void 0&&r(s.pipe(new j.Transform({async transform(p,y,P){try{d+=p.length,o?.({total:h,downloaded:d,percent:d/h*100}),P(null,m.update(p))}catch(ie){P(ie)}},async flush(p){try{p(null,m.final())}catch(y){p(y)}}}))),r(s)});var Z=g("stream");var z=async(t,e={})=>new Promise(async(r,n)=>{let o=new Z.PassThrough,{onProgress:i,bytesWanted:a}=e??{},c=0,s=0;if(a===void 0){let d=await Promise.all(t.map(async h=>{let m=await w(h).then(k);s+=b(m.headers);let p=[];return m.on("data",y=>{p.push(y),c+=y.length,i?.({total:s,downloaded:c,percent:c/s*100})}),m.on("error",n),new Promise(y=>m.on("end",()=>y(Buffer.concat(p))))}));o.write(Buffer.concat(d))}else for(let d of t){let h=await w(d).then(k);if(s+=b(h.headers),h.on("data",m=>{o.write(m),c+=m.length,i?.({total:s,downloaded:c,percent:c/s*100})}),h.on("error",n),await new Promise(m=>h.on("end",m)),c>=a)break}o.end(),r(o)});var Q=async({manifestMimeType:t,manifest:e},r={})=>{switch(t){case"application/vnd.tidal.bts":return J(e.urls[0],{...r,manifest:e});case"application/dash+xml":{let n=e.tracks.audios[0];return z(n.segments.map(o=>o.url),r)}default:throw new Error(`Unsupported Stream Info manifest mime type: ${t}`)}};var ne=g("fs"),q=g("fs/promises"),oe=H(g("path"));var N=g("stream");var L=class{},l=(t,e)=>{let r=Buffer.alloc(t);return e(r),r};var u;(function(t){t[t.StreamInfo=0]="StreamInfo",t[t.Padding=1]="Padding",t[t.Application=2]="Application",t[t.SeekTable=3]="SeekTable",t[t.VorbisComment=4]="VorbisComment",t[t.CueSheet=5]="CueSheet",t[t.Picture=6]="Picture",t[t.Invalid=127]="Invalid"})(u||(u={}));var U=4,f=class t extends L{type;dataLength;isLast;constructor(e,r=0,n=!1){super(),this.type=e,this.dataLength=r,this.isLast=n,this.isLast=n,this.type=e,this.dataLength=r}static SIZE=4;static fromBuffer(e){let r=e.readUint8();return new t(r&127,e.readUintBE(1,3),(r&128)===1)}toBuffer(){return l(this.length,e=>{e.writeUint8(this.type+(this.isLast?128:0)),e.writeUintBE(this.dataLength,1,3)})}get length(){return U}};var re=H(te(),1);var x=class extends L{};var D;(function(t){t[t.Other=0]="Other",t[t.FileIcon=1]="FileIcon",t[t.OtherFileIcon=2]="OtherFileIcon",t[t.FrontCover=3]="FrontCover",t[t.BackCover=4]="BackCover",t[t.LeafletPage=5]="LeafletPage",t[t.Media=6]="Media",t[t.LeadArtist=7]="LeadArtist",t[t.Artist=8]="Artist",t[t.Conductor=9]="Conductor",t[t.Band=10]="Band",t[t.Composer=11]="Composer",t[t.Lyricist=12]="Lyricist",t[t.RecordingLocation=13]="RecordingLocation",t[t.DuringRecording=14]="DuringRecording",t[t.DuringPerformance=15]="DuringPerformance",t[t.MovieScreenCapture=16]="MovieScreenCapture",t[t.ABrightColouredFish=17]="ABrightColouredFish",t[t.Illustration=18]="Illustration",t[t.BandLogotype=19]="BandLogotype",t[t.PublisherLogotype=20]="PublisherLogotype"})(D||(D={}));var C=class t extends x{header;pictureType;mime;description;width;height;colorDepth;colors;pictureBuffer;constructor(e){super();let{header:r=new f(u.Picture),pictureType:n=D.FrontCover,mime:o,description:i="",width:a,height:c,colorDepth:s=24,colors:d=0,buffer:h}=e;if(this.header=r,this.pictureType=n,o&&a&&c)this.mime=o,this.width=a,this.height=c;else{let m=(0,re.default)(h);this.mime=o??m.mimeType,this.width=a??m.width,this.height=c??m.height}this.description=i,this.colorDepth=s,this.colors=d,this.pictureBuffer=h}static fromBuffer(e){let r=0,n=f.fromBuffer(e);if(n.type!==u.Picture)throw new Error(`Invalid picture block header type! Expected type ${u.Picture} got ${n.type}`);r+=n.length;let o=e.readUintBE(r,4);r+=4;let i=e.readUintBE(r,4);r+=4;let a=e.subarray(r,r+i).toString();r+=i;let c=e.readUintBE(r,4);r+=4;let s=e.subarray(r,r+c).toString();r+=c;let d=e.readUintBE(r,4);r+=4;let h=e.readUintBE(r,4);r+=4;let m=e.readUintBE(r,4);r+=4;let p=e.readUintBE(r,4);r+=4;let y=e.readUintBE(r,4);r+=4;let P=e.subarray(r,r+y);return new t({header:n,pictureType:o,mime:a,description:s,width:d,height:h,colorDepth:m,colors:p,buffer:P})}toBuffer(){return Buffer.concat([this.header.toBuffer(),l(4,e=>e.writeUint32BE(this.pictureType)),l(4,e=>e.writeUint32BE(Buffer.byteLength(this.mime))),Buffer.from(this.mime),l(4,e=>e.writeUint32BE(Buffer.byteLength(this.description))),Buffer.from(this.description),l(4,e=>e.writeUint32BE(this.width)),l(4,e=>e.writeUint32BE(this.height)),l(4,e=>e.writeUint32BE(this.colorDepth)),l(4,e=>e.writeUint32BE(this.colors)),l(4,e=>e.writeUint32BE(this.pictureBuffer.length)),this.pictureBuffer])}toPicture(){return{pictureType:this.pictureType,mime:this.mime,description:this.description,colorDepth:this.colorDepth,colors:this.colors,buffer:this.pictureBuffer}}get length(){return U+4+4+Buffer.byteLength(this.mime)+4+Buffer.byteLength(this.description)+4*5+this.pictureBuffer.length}};var R=class t extends x{header;vendorString;commentList;constructor(e={}){super();let{header:r=new f(u.VorbisComment),vendorString:n="",commentList:o=[]}=e;this.header=r,this.vendorString=n,this.commentList=o}static fromBuffer(e){let r=0,n=f.fromBuffer(e);if(n.type!==u.VorbisComment)throw new Error(`Invalid vorbis comment block header type! Expected type ${u.VorbisComment} got ${n.type}`);r+=n.length;let o=e.readUintLE(r,4);r+=4;let i=e.subarray(r,r+o).toString();r+=o;let a=[],c=e.readUintLE(r,4);r+=4;for(let s=0;s<c;s++){let d=e.readUintLE(r,4);r+=4;let h=e.subarray(r,r+d).toString();r+=d,a.push(h)}return new t({header:n,vendorString:i,commentList:a})}toBuffer(){let e=Buffer.alloc(this.commentListLength),r=0;for(let o of this.commentList){let i=Buffer.byteLength(o);e.writeUintLE(i,r,4),r+=4,e.write(o,r),r+=i}let n=Buffer.from(this.vendorString);return Buffer.concat([this.header.toBuffer(),l(4,o=>o.writeUint32LE(n.length)),n,l(4,o=>o.writeUint32LE(this.commentList.length)),e])}toTagMap(){let e=new Proxy({},{get(r,n,o){return Reflect.get(r,n.toString().toUpperCase(),o)},set(r,n,o,i){return Reflect.set(r,n.toString().toUpperCase(),o,i)}});for(let r of this.commentList){let n=r.indexOf("=");if(n===-1)continue;let o=r.substring(0,n),i=r.substring(n+1),a=e[o];a?Array.isArray(a)?a.push(i):e[o]=[a,i]:e[o]=i}return e}get commentListLength(){return this.commentList.map(e=>Buffer.byteLength(e)+4).reduce((e,r)=>e+r,0)}get length(){return U+4+Buffer.byteLength(this.vendorString)+4+this.commentListLength}};var O=class t extends x{header;data;constructor(e,r){super(),this.header=e,this.data=r}static fromBuffer(e){let r=f.fromBuffer(e);return new t(r,e.subarray(r.length,r.length+r.dataLength))}toBuffer(){return Buffer.concat([this.header.toBuffer(),this.data])}get length(){return this.header.length+this.data.length}};var T=class t extends N.Transform{index=0;done=!1;headerBuffer=Buffer.alloc(0);_metaBlocks=[];_metaBlocksReady;_metaBlocksInner;picBlock;vorbisBlock;readOnly=!0;static StreamMarker="fLaC";static fromBuffer(e,r){let n=new t(r),o=new N.Readable;return o.push(e),o.push(null),o.pipe(n),n}static fromStream(e,r){let n=new this(r);return e.pipe(n),n}toBuffer(){if(this.readOnly)throw new Error("Stream is read-only");return new Promise((e,r)=>{let n=[];this.on("data",o=>n.push(o)),this.on("end",()=>e(Buffer.concat(n))),this.on("error",r)})}constructor(e={}){super(),this.readOnly=e===void 0,this._metaBlocksReady=new Promise((o,i)=>this._metaBlocksInner={res:o,rej:i});let{tagMap:r,picture:n}=e;if(r!==void 0){this.vorbisBlock=new R;for(let o in r){let i=r[o];if(Array.isArray(i))for(let a of i)this.vorbisBlock.commentList.push(`${o.toUpperCase()}=${a}`);else this.vorbisBlock.commentList.push(`${o.toUpperCase()}=${i}`)}this._metaBlocks.push(this.vorbisBlock)}n!==void 0&&(this.picBlock=new C(n),this.picBlock.header.isLast=!0,this.picBlock.header.dataLength=this.picBlock.length-this.picBlock.header.length,this._metaBlocks.push(this.picBlock))}async tags(){return await this._metaBlocksReady,{tagMap:this.vorbisBlock?.toTagMap()??void 0,picture:this.picBlock?.toPicture()??void 0}}async metaBlocks(){return await this._metaBlocksReady,this._metaBlocks}onDone(e){this.done=!0,e(null,Buffer.concat([Buffer.from(t.StreamMarker),...this._metaBlocks.sort((r,n)=>r.header.type-n.header.type).map((r,n)=>{let o=n===this._metaBlocks.length-1;return r.header.isLast=o,r.header.dataLength=r.length-r.header.length,r.toBuffer()}),this.headerBuffer.subarray(this.index)])),this._metaBlocksInner?.res?.()}_flush(e){let r=this.safeCallback(e);return!this.done&&!this.readOnly?this.onDone(r):r()}safeCallback(e){return(r,n)=>(r&&this._metaBlocksInner?.rej?.(r),this.readOnly?e(r):e(r,n))}_transform(e,r,n){let o=this.safeCallback(n);try{if(this.done)return o(null,e);if(this.headerBuffer=Buffer.concat([this.headerBuffer,e]),this.index===0){if(this.headerBuffer.length<4)return o(new Error(`Invalid stream header, must be at least 4 bytes long got ${this.headerBuffer.length}`));let i=this.headerBuffer.toString("utf8",0,4);if(i!==t.StreamMarker)return o(new Error(`Invalid stream header: ${i}`));this.index=4}for(;this.index+f.SIZE<this.headerBuffer.length;){let{dataLength:i,type:a,length:c,isLast:s}=f.fromBuffer(this.headerBuffer.subarray(this.index,this.index+f.SIZE));if(a===u.Invalid)return this.onDone(o);let d=i+c;if(this.index+d>this.headerBuffer.length)break;let h=this.headerBuffer.subarray(this.index,this.index+d);this.index+=d;let m;switch(a){case u.VorbisComment:this.vorbisBlock===void 0&&(m=R.fromBuffer(h),this._metaBlocks.push(m),this.vorbisBlock=m);break;case u.Picture:m=C.fromBuffer(h),this.picBlock?.pictureType!==m.pictureType&&(this._metaBlocks.push(m),this.picBlock=m);break;default:m=O.fromBuffer(h),this._metaBlocks.push(m);break}if(s)return this.onDone(o)}o()}catch(i){o(i)}}};var be=async(t,e,r)=>{if(r===void 0)return e;let{tags:n,coverUrl:o}=r;if(t.manifestMimeType==="application/vnd.tidal.bts")switch(t.manifest.codecs){case"flac":{let i;if(o!==void 0)try{i={pictureType:D.FrontCover,buffer:await w(o).then(k).then(F)}}catch{}return e.pipe(new T({tagMap:n,picture:i}))}}return e},Ue=t=>(0,q.stat)(t).then(()=>!0).catch(()=>!1),Me=process.platform==="win32"?"\\\\":"/",I={},De=async(t,e,r)=>{let n=JSON.stringify(e);if(I[n]!==void 0)throw new Error(`Something is already downloading to ${n}`);try{let o=oe.default.join(e.basePath??"",e.folderPath);o!=="."&&await(0,q.mkdir)(o,{recursive:!0});let i=`${o}${Me}${e.fileName}`;if(await Ue(i))return delete I[n],Promise.resolve();let a=await Q(t,{onProgress:d=>I[n]=d}),c=await be(t,a,r),s=(0,ne.createWriteStream)(i);return new Promise((d,h)=>c.pipe(s).on("finish",()=>{delete I[n],d()}).on("error",h))}catch(o){throw delete I[n],o}},Ce=t=>I[t];return ue(Re);})();\n',"neptuneExports");var Ce=r=>(...e)=>window.electron.ipcRenderer.invoke("___lib/native/downloadTrack.native.ts",r,...e).catch(t=>{let i=t.stack?.replaceAll("Error invoking remote method '___lib/native/downloadTrack.native.ts': Error: ","");throw new Error(`[_lib/native/downloadTrack.native.ts.${r}] ${i}`)}),Pe=Ce("getDownloadProgress"),ke=Ce("startTrackDownload");var gt=NeptuneNative.createEvalScope(`
						electron.ipcMain.removeHandler("___lib/native/request/requestJsonCached.native.ts_registerExports");
						electron.ipcMain.handle("___lib/native/request/requestJsonCached.native.ts_registerExports", (_, code, globalName) => {
							const exports = eval(\`(() => {\${code};return \${globalName};})()\`)
							electron.ipcMain.removeHandler("___lib/native/request/requestJsonCached.native.ts");
							electron.ipcMain.handle("___lib/native/request/requestJsonCached.native.ts", (_, exportName, ...args) => exports[exportName](...args));
						});
					`);NeptuneNative.deleteEvalScope(gt);await window.electron.ipcRenderer.invoke("___lib/native/request/requestJsonCached.native.ts_registerExports",'"use strict";var neptuneExports=(()=>{var f=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var L=Object.prototype.hasOwnProperty;var h=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error(\'Dynamic require of "\'+e+\'" is not supported\')});var P=(e,t)=>{for(var n in t)f(e,n,{get:t[n],enumerable:!0})},q=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of O(t))!L.call(e,a)&&a!==n&&f(e,a,{get:()=>t[a],enumerable:!(s=R(t,a))||s.enumerable});return e};var C=e=>q(f({},"__esModule",{value:!0}),e);var S={};P(S,{requestJsonCached:()=>D});var T=h("electron"),c=(e,...t)=>{for(let n of T.BrowserWindow.getAllWindows())n.webContents.send(e,...t)};var $=e=>{let t=r=>{let i=(...o)=>{r(e,...o)};return i.withContext=o=>(...u)=>{r(e,o,...u)},i},n=t((...r)=>c("NEPTUNE_RENDERER_LOG","log",...r)),s=t((...r)=>c("NEPTUNE_RENDERER_LOG","warn",...r)),a=t((...r)=>c("NEPTUNE_RENDERER_LOG","error",...r)),m=t((...r)=>c("NEPTUNE_RENDERER_LOG","debug",...r));return{log:n,warn:s,err:a,debug:m}},d=$("[lib.native]");var y=e=>{if(!(e.statusCode!==void 0&&e.statusCode>=200&&e.statusCode<300))throw p(e).then(n=>d.err(`(${e.statusCode})`,n,e.url)).catch(()=>{}),new Error(`Status code is ${e.statusCode}`);return e},p=e=>N(e).then(t=>JSON.parse(t.toString())),N=e=>new Promise((t,n)=>{let s=[];e.on("data",a=>s.push(a)),e.on("end",()=>t(Buffer.concat(s))),e.on("error",n)});var E=h("https");var g=class{constructor(t){this.avalibleSlots=t}queued=[];async obtain(){let t=!1,n=()=>{t||(t=!0,this.avalibleSlots++,this.queued.shift()?.())};return this.avalibleSlots>0?(this.avalibleSlots--,n):new Promise(s=>{this.queued.push(()=>{this.avalibleSlots--,s(n)})})}};var I="Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) TIDAL/9999.9999.9999 Chrome/126.0.6478.127 Electron/31.2.1 Safari/537.36";var M=new g(1),l=async(e,t={})=>{let n=Date.now();t.headers??={},t.headers["user-agent"]=I,t.rateLimit??=0;let s=t.rateLimit>0?await M.obtain():void 0;return new Promise((a,m)=>{let r=t.body;delete t.body,r!==void 0&&(t.headers??={},t.headers["Content-Length"]=Buffer.byteLength(r));let i=(0,E.request)(e,t,o=>{o.url=e;let u=o.statusMessage!==""?` - ${o.statusMessage}`:"";if(o.statusCode===429||o.statusCode===503){let b=parseInt(o.headers["retry-after"]??"1",10);return t.rateLimit++,d.debug(`[${o.statusCode}${u}] (${i.method} - ${Date.now()-n}ms)`,`[Attempt ${t.rateLimit}, Retry in ${b}s]`,e),setTimeout(()=>{s?.(),l(e,t).then(a,m)},b)}t.rateLimit>0?d.debug(`[${o.statusCode}${u}] (${i.method} - ${Date.now()-n}ms)`,`[After ${t.rateLimit} attempts]`,e):d.debug(`[${o.statusCode}${u}] (${i.method} - ${Date.now()-n}ms)`,e),a(o)});i.on("error",m),r!==void 0&&i.write(r),i.end()}).finally(s)};var w=async(e,t={})=>l(e,t).then(y).then(p);var x={},D=async(e,t)=>{let n=x[e];return n!==void 0?(d.debug("[CACHE HIT]",e),n):x[e]=w(e,t)};return C(S);})();\n',"neptuneExports");var bt=r=>(...e)=>window.electron.ipcRenderer.invoke("___lib/native/request/requestJsonCached.native.ts",r,...e).catch(t=>{let i=t.stack?.replaceAll("Error invoking remote method '___lib/native/request/requestJsonCached.native.ts': Error: ","");throw new Error(`[_lib/native/request/requestJsonCached.native.ts.${r}] ${i}`)}),De=bt("requestJsonCached");var yt=NeptuneNative.createEvalScope(`
						electron.ipcMain.removeHandler("___lib/native/request/requestStream.native.ts_registerExports");
						electron.ipcMain.handle("___lib/native/request/requestStream.native.ts_registerExports", (_, code, globalName) => {
							const exports = eval(\`(() => {\${code};return \${globalName};})()\`)
							electron.ipcMain.removeHandler("___lib/native/request/requestStream.native.ts");
							electron.ipcMain.handle("___lib/native/request/requestStream.native.ts", (_, exportName, ...args) => exports[exportName](...args));
						});
					`);NeptuneNative.deleteEvalScope(yt);await window.electron.ipcRenderer.invoke("___lib/native/request/requestStream.native.ts_registerExports",'"use strict";var neptuneExports=(()=>{var l=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var T=Object.getOwnPropertyNames;var p=Object.prototype.hasOwnProperty;var b=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error(\'Dynamic require of "\'+t+\'" is not supported\')});var R=(t,e)=>{for(var r in e)l(t,r,{get:e[r],enumerable:!0})},$=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of T(e))!p.call(t,a)&&a!==r&&l(t,a,{get:()=>e[a],enumerable:!(o=y(e,a))||o.enumerable});return t};var x=t=>$(l({},"__esModule",{value:!0}),t);var v={};R(v,{requestStream:()=>w,setDefaultUserAgent:()=>P});var E=b("https");var h=b("electron"),u=(t,...e)=>{for(let r of h.BrowserWindow.getAllWindows())r.webContents.send(t,...e)};var N=t=>{let e=n=>{let i=(...s)=>{n(t,...s)};return i.withContext=s=>(...d)=>{n(t,s,...d)},i},r=e((...n)=>u("NEPTUNE_RENDERER_LOG","log",...n)),o=e((...n)=>u("NEPTUNE_RENDERER_LOG","warn",...n)),a=e((...n)=>u("NEPTUNE_RENDERER_LOG","error",...n)),m=e((...n)=>u("NEPTUNE_RENDERER_LOG","debug",...n));return{log:r,warn:o,err:a,debug:m}},g=N("[lib.native]");var c=class{constructor(e){this.avalibleSlots=e}queued=[];async obtain(){let e=!1,r=()=>{e||(e=!0,this.avalibleSlots++,this.queued.shift()?.())};return this.avalibleSlots>0?(this.avalibleSlots--,r):new Promise(o=>{this.queued.push(()=>{this.avalibleSlots--,o(r)})})}};var L="Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) TIDAL/9999.9999.9999 Chrome/126.0.6478.127 Electron/31.2.1 Safari/537.36",P=async t=>L=t,q=new c(1),w=async(t,e={})=>{let r=Date.now();e.headers??={},e.headers["user-agent"]=L,e.rateLimit??=0;let o=e.rateLimit>0?await q.obtain():void 0;return new Promise((a,m)=>{let n=e.body;delete e.body,n!==void 0&&(e.headers??={},e.headers["Content-Length"]=Buffer.byteLength(n));let i=(0,E.request)(t,e,s=>{s.url=t;let d=s.statusMessage!==""?` - ${s.statusMessage}`:"";if(s.statusCode===429||s.statusCode===503){let f=parseInt(s.headers["retry-after"]??"1",10);return e.rateLimit++,g.debug(`[${s.statusCode}${d}] (${i.method} - ${Date.now()-r}ms)`,`[Attempt ${e.rateLimit}, Retry in ${f}s]`,t),setTimeout(()=>{o?.(),w(t,e).then(a,m)},f)}e.rateLimit>0?g.debug(`[${s.statusCode}${d}] (${i.method} - ${Date.now()-r}ms)`,`[After ${e.rateLimit} attempts]`,t):g.debug(`[${s.statusCode}${d}] (${i.method} - ${Date.now()-r}ms)`,t),a(s)});i.on("error",m),n!==void 0&&i.write(n),i.end()}).finally(o)};return x(v);})();\n',"neptuneExports");var _e=r=>(...e)=>window.electron.ipcRenderer.invoke("___lib/native/request/requestStream.native.ts",r,...e).catch(t=>{let i=t.stack?.replaceAll("Error invoking remote method '___lib/native/request/requestStream.native.ts': Error: ","");throw new Error(`[_lib/native/request/requestStream.native.ts.${r}] ${i}`)}),fi=_e("requestStream"),Ne=_e("setDefaultUserAgent");Ne(navigator.userAgent).catch(p.err.withContext("Failed to set default user agent"));var Oe=new h("requestCache"),v=async(r,e)=>{let t=De(r,e).then(a=>(Oe.put(a,r).catch(p.err.withContext("requestCache.put")),a)),i=await Promise.race([t,Oe.get(r).catch(p.err.withContext("requestCache.get"))]);return i!==void 0?i:t};var I=class{constructor(e,t){this.trackId=e;this.tidalTrack=t}_releaseTrack;_releaseAlbum;static current(e){if(e??=O()?.playbackContext,e?.actualProductId!==void 0)return this.get(e.actualProductId)}static async get(e){if(e===void 0)return;let t=await g.ensure(e);if(t!==void 0)return new this(e,t)}async isrcs(){let e=[],t=await this.releaseTrack();t?.recording.isrcs&&e.push(...t.recording.isrcs);let i=this.tidalTrack;return i.isrc&&e.push(i.isrc),new Set(e)}tidalAlbum(){return S.get(this.tidalTrack.album?.id)}async releaseAlbum(){if(this._releaseAlbum!==void 0)return this._releaseAlbum;if(this.tidalTrack.album?.id===void 0)return;let t=await this.tidalAlbum();if(t?.upc===void 0)return;let i=await v(`https://musicbrainz.org/ws/2/release/?query=barcode:${t.upc}&fmt=json`).then(({releases:s})=>s[0]).catch(p.warn.withContext("MusicBrainz.getUPCReleases")),a=i?.media?.[(this.tidalTrack.volumeNumber??1)-1]?.["track-count"];if(a!==void 0&&t.numberOfTracks!==void 0&&a!==t.numberOfTracks){p.warn("Invalid Tidal UPC for album!",{releaseAlbum:i,tidalAlbum:t});return}return this._releaseAlbum=i}async releaseTrack(){if(this._releaseTrack!==void 0)return this._releaseTrack;let e=async n=>{let o=await v(`https://musicbrainz.org/ws/2/recording/${n.id}?inc=releases+media+artist-credits+isrcs&fmt=json`).then(({releases:l})=>l?.filter(m=>m["text-representation"].language==="eng")[0]??l?.[0]).catch(p.warn.withContext("MusicBrainz.getISRCRecordings"));if(o===void 0)return;let u=o.media?.[0].tracks?.[0];return u.recording??=n,u};if(this.tidalTrack.isrc!==void 0){let n=await v(`https://musicbrainz.org/ws/2/isrc/${this.tidalTrack.isrc}?inc=isrcs&fmt=json`).then(({recordings:o})=>o[0]).catch(p.warn.withContext("MusicBrainz.getISRCRecordings"));if(n!==void 0)return this._releaseTrack=await e(n)}let t=await this.releaseAlbum();if(t===void 0)return;let i=await v(`https://musicbrainz.org/ws/2/release/${t.id}?inc=recordings+isrcs+artist-credits&fmt=json`).catch(p.warn.withContext("MusicBrainz.getReleaseAlbum")),a=(this.tidalTrack.volumeNumber??1)-1,s=(this.tidalTrack.trackNumber??1)-1;return this._releaseTrack=i?.media?.[a]?.tracks?.[s],i?.["text-representation"].language!=="eng"&&this._releaseTrack?.recording!==void 0?this._releaseTrack=await e(this._releaseTrack.recording):this._releaseTrack}};var Tt=NeptuneNative.createEvalScope(`
						electron.ipcMain.removeHandler("___lib/native/request/requestJson.native.ts_registerExports");
						electron.ipcMain.handle("___lib/native/request/requestJson.native.ts_registerExports", (_, code, globalName) => {
							const exports = eval(\`(() => {\${code};return \${globalName};})()\`)
							electron.ipcMain.removeHandler("___lib/native/request/requestJson.native.ts");
							electron.ipcMain.handle("___lib/native/request/requestJson.native.ts", (_, exportName, ...args) => exports[exportName](...args));
						});
					`);NeptuneNative.deleteEvalScope(Tt);await window.electron.ipcRenderer.invoke("___lib/native/request/requestJson.native.ts_registerExports",'"use strict";var neptuneExports=(()=>{var f=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var h=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error(\'Dynamic require of "\'+t+\'" is not supported\')});var L=(t,e)=>{for(var n in e)f(t,n,{get:e[n],enumerable:!0})},O=(t,e,n,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of x(e))!R.call(t,a)&&a!==n&&f(t,a,{get:()=>e[a],enumerable:!(s=T(e,a))||s.enumerable});return t};var P=t=>O(f({},"__esModule",{value:!0}),t);var M={};L(M,{requestJson:()=>I});var y=h("electron"),c=(t,...e)=>{for(let n of y.BrowserWindow.getAllWindows())n.webContents.send(t,...e)};var $=t=>{let e=r=>{let i=(...o)=>{r(t,...o)};return i.withContext=o=>(...u)=>{r(t,o,...u)},i},n=e((...r)=>c("NEPTUNE_RENDERER_LOG","log",...r)),s=e((...r)=>c("NEPTUNE_RENDERER_LOG","warn",...r)),a=e((...r)=>c("NEPTUNE_RENDERER_LOG","error",...r)),m=e((...r)=>c("NEPTUNE_RENDERER_LOG","debug",...r));return{log:n,warn:s,err:a,debug:m}},d=$("[lib.native]");var w=t=>{if(!(t.statusCode!==void 0&&t.statusCode>=200&&t.statusCode<300))throw p(t).then(n=>d.err(`(${t.statusCode})`,n,t.url)).catch(()=>{}),new Error(`Status code is ${t.statusCode}`);return t},p=t=>q(t).then(e=>JSON.parse(e.toString())),q=t=>new Promise((e,n)=>{let s=[];t.on("data",a=>s.push(a)),t.on("end",()=>e(Buffer.concat(s))),t.on("error",n)});var E=h("https");var g=class{constructor(e){this.avalibleSlots=e}queued=[];async obtain(){let e=!1,n=()=>{e||(e=!0,this.avalibleSlots++,this.queued.shift()?.())};return this.avalibleSlots>0?(this.avalibleSlots--,n):new Promise(s=>{this.queued.push(()=>{this.avalibleSlots--,s(n)})})}};var C="Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) TIDAL/9999.9999.9999 Chrome/126.0.6478.127 Electron/31.2.1 Safari/537.36";var N=new g(1),l=async(t,e={})=>{let n=Date.now();e.headers??={},e.headers["user-agent"]=C,e.rateLimit??=0;let s=e.rateLimit>0?await N.obtain():void 0;return new Promise((a,m)=>{let r=e.body;delete e.body,r!==void 0&&(e.headers??={},e.headers["Content-Length"]=Buffer.byteLength(r));let i=(0,E.request)(t,e,o=>{o.url=t;let u=o.statusMessage!==""?` - ${o.statusMessage}`:"";if(o.statusCode===429||o.statusCode===503){let b=parseInt(o.headers["retry-after"]??"1",10);return e.rateLimit++,d.debug(`[${o.statusCode}${u}] (${i.method} - ${Date.now()-n}ms)`,`[Attempt ${e.rateLimit}, Retry in ${b}s]`,t),setTimeout(()=>{s?.(),l(t,e).then(a,m)},b)}e.rateLimit>0?d.debug(`[${o.statusCode}${u}] (${i.method} - ${Date.now()-n}ms)`,`[After ${e.rateLimit} attempts]`,t):d.debug(`[${o.statusCode}${u}] (${i.method} - ${Date.now()-n}ms)`,t),a(o)});i.on("error",m),r!==void 0&&i.write(r),i.end()}).finally(s)};var I=async(t,e={})=>l(t,e).then(w).then(p);return P(M);})();\n',"neptuneExports");var Et=r=>(...e)=>window.electron.ipcRenderer.invoke("___lib/native/request/requestJson.native.ts",r,...e).catch(t=>{let i=t.stack?.replaceAll("Error invoking remote method '___lib/native/request/requestJson.native.ts': Error: ","");throw new Error(`[_lib/native/request/requestJson.native.ts.${r}] ${i}`)}),Le=Et("requestJson");var wt="tzecdDS3Bbx00rMP",vt="zhRnKETi4FeXNGB72yAPJDssJ1U3BBGqmvYKcaw3kk8=",k={token:"",expiresAt:-1},It=new E(1),Me=async()=>{let r=await It.obtain();try{if(k.expiresAt>Date.now())return k.token;let{access_token:e,expires_in:t}=await Le("https://auth.tidal.com/v1/oauth2/token",{method:"POST",headers:{Authorization:`Basic ${btoa(`${wt}:${vt}`)}`,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials"}).toString()});return k.token=e,k.expiresAt=Date.now()+(t-60)*1e3,k.token}finally{r()}};var At=async(r,e)=>{let{limit:t,offset:i}=e??{limit:100,offset:0};return v(`https://openapi.tidal.com/tracks/byIsrc?isrc=${r}&countryCode=US&limit=${t}&offset=${i}`,{headers:{Authorization:`Bearer ${await Me()}`,"Content-Type":"application/vnd.tidal.v1+json"}})};async function*Be(r){let e=0,t=100;for(;;){let i=await At(r,{limit:t,offset:e});if(i?.data!==void 0&&(yield*i.data),i.data.length<t)break;e+=t}}var Z=r=>{let e={};return t=>t in e?e[t]:e[t]=r(t)};var $=class{static getMaxTrack=Z(async e=>{let t=await I.get(e);if(t===void 0||t.tidalTrack.contentType==="track"&&this.hasHiRes(t.tidalTrack))return!1;for await(let i of this.getTracksFromMediaItem(t,this.hasHiRes))return i;return!1});static getLatestMaxTrack=Z(async e=>{let t=await I.get(e);if(t===void 0)return!1;let i=!1;for await(let a of this.getTracksFromMediaItem(t)){if(i===void 0){i=a;continue}let s=!this.hasHiRes(a)&&this.hasHiRes(i),n=this.hasHiRes(a)&&!this.hasHiRes(i);if(s)continue;if(n){i=a;continue}if(new Date(a.streamStartDate)>new Date(i.streamStartDate)){i=a;continue}}return i});static async*getTracksFromMediaItem(e,t){let{tidalTrack:i}=e,a=await e.isrcs();if(a.size!==0)for(let s of a)for await(let n of this.getTracksFromISRC(s,t))n.id!==i.id&&(yield n)}static async*getTracksFromISRC(e,t){for await(let{resource:i}of Be(e)){if(i?.id===void 0||i.artifactType!=="track"||t&&!t(i))continue;let a=await g.ensureTrack(i?.id);a!==void 0&&(yield a)}}static hasHiRes(e){let t=e.mediaMetadata?.tags;return t===void 0?!1:t.includes("HIRES_LOSSLESS")}};var St=G("[SongDownloader]"),C={},xt=r=>({prep:()=>{let e=C[r];e.disabled=!0,e.classList.add("loading"),e.textContent="Fetching Meta..."},onProgress:({total:e,downloaded:t,percent:i})=>{let a=C[r];a.style.setProperty("--progress",`${i}%`);let s=(t/1048576).toFixed(0),n=(e/1048576).toFixed(0);a.textContent=`Downloading... ${s}/${n}MB ${i.toFixed(0)}%`},set:e=>{let t=C[r];t.textContent=e},clear:()=>{let e=C[r];e.classList.remove("loading"),e.disabled=!1,e.style.removeProperty("--progress"),e.textContent="Download"}}),sa=we;R.onOpen(async(r,e,t)=>{if(document.getElementById("download-button")?.remove(),t.length===0)return;let i=document.createElement("button");i.type="button",i.role="menuitem",i.textContent=t.length>1?`Download ${t.length} tracks`:"Download track",i.id="download-button",i.className="context-button";let a=JSON.stringify(t.map(n=>n.id).sort());C[a]?.disabled===!0&&(i.disabled=!0,i.classList.add("loading")),C[a]=i;let s=xt(a);e.appendChild(i),i.addEventListener("click",async()=>{if(a===void 0)return;let n;if(c.alwaysUseDefaultPath)n=c.defaultDownloadPath;else if(t.length>1){s.set("Prompting for download folder...");let o=await xe({properties:["openDirectory","createDirectory"],defaultPath:n});if(o.canceled)return s.clear();n=o.filePaths[0]}s.prep();for(let o of t)o.id!==void 0&&await Rt(o,s,n).catch(St.msg.err.withContext("Error downloading track"));s.clear()})});var Rt=async(r,e,t)=>{let i=r.id;if(c.useRealMAX&&c.desiredDownloadQuality==="HI_RES_LOSSLESS"){e.set("Checking RealMAX for better quality...");let d=await $.getMaxTrack(i);d!==!1&&(i=+d.id)}e.set("Fetching playback info & tags...");let a=B.ensure(i,c.desiredDownloadQuality),s=ae(await I.get(i)),n=ce(await s,await a);if(n.basePath=t,t===void 0){e.set("Prompting for download path...");let d=n.fileName,b=await Re({defaultPath:`${t??""}${T}${d}`,filters:[{name:"",extensions:[d??"*"]}]});if(b.canceled)return e.clear();let y=b.filePath.split(T);y.pop(),n.basePath=y.join(T)}e.set("Downloading...");let o=!1,u=ke(await a,n,await s).finally(()=>o=!0),l=JSON.stringify(n),m=async()=>{let d=await Pe(l);d!==void 0&&e.onProgress(d),o||setTimeout(m,100)};return m(),u};export{je as Settings,sa as onUnload};
